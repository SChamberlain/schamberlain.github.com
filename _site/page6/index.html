<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Richard Huang - Richard Huang's Website</title>
    <meta name="author" content="Richard Huang" />
    <meta name="google-site-verification" content="KDVRO6hdZ0Vww31dac2Yomyd7xjmMMFEZw2Fzq5acuY" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/screen.css">
    <link href="http://feeds.feedburner.com/richard-huang" rel="alternate" title="RSS" type="application/rss+xml" />
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="/javascripts/jquery.github_v2.js"></script>
  </head>

  <body>
    <div id="header" class="section">
      <div class="wrapper">
        <strong id="blog-title">
          <a href="/" rel="home">Richard Huang's Website</a>
        </strong>
        <p id="blog-description"></p>
        <div id="navigation">
          <ul class="nav clearfix">
            <li class="first-child"><a href="/blog.html">Blog</a></li>
            <li><a href="/projects.html">Projects</a></li>
            <li><a href="/about.html">About</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div id="main" class="section">
      <div class="wrapper">
        <div id="content">
          <!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
  <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
  <a class="addthis_button_tweet"></a>
  <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
  <a class="addthis_counter addthis_pill_style"></a>
</div>
<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=flyerhzm"></script>
<!-- AddThis Button END -->

  <div class="full">
    <h1 class="entry-title">
      <a href="/2010/05/20/tracking-image-views-in-the-external-system/" title="追踪图片在外部系统的查看次数" rel="bookmark">追踪图片在外部系统的查看次数</a>
    </h1>
    <div class="entry-content full-content">
      <p>随着sns网站和web api的兴起，与第三方网站的交互越来越多。比如我们可以向用户facebook好友上的wall推送数据等等来做网站的推广，这就引来一个问题，我们不能只傻乎乎地做推广，更重要的是统计推广的效果。你总共推送了多少数据，有多少人看到了这些数据，又有多少人点击来到了你的网站？这些数据都是可以用来帮助你改进和提高推广的效果。</p>

<p>对于推送了多少数据和有多少人看到了这些数据，这两者比较容易做到，前者可以在推送数据的时候做记录，后者可以在用户点击进入网站的时候做记录。对于有多少人看到了这些数据就比较麻烦了。</p>

<p>下面拿facebook为例介绍如何统计数据在外部系统的查看次数。如果是纯文字的话几乎没法做到，但是如果是推送图片或视频的话，可以通过图片的显示次数来统计数据。</p>

<p>一般往facebook推送图片或视频等图片的时候，只需要在推送的参数中设置图片或视频的完整url即可。然后facebook在显示图片或视频的时候，会发送请求到服务器上，你只需要捕获这个请求并添加相应的逻辑处理。但是问题是，一般部署的rails应用，除了使用rails server(如thin)，还会放置一个web server(如nginx)来做负载均衡，你的图片或视频的请求会直接被web server处理，根本不经过rails server，这样你的逻辑代码就永远不会被调用到了。</p>

<p>解决的方法就是把传递给facebook的图片或视频url由静态url改成动态url，比如：http://yourdomain.com/assets/test.png改成http://yourdomain.com/assets/1，然后由assets_controller来返回图片</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">AssetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">asset</span> <span class="o">=</span> <span class="no">Asset</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="c1"># add logic to increment asset show count</span>

    <span class="n">send_file</span> <span class="n">asset</span><span class="o">.</span><span class="n">attachment</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="ss">:small</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>


<p>到此为止，你已经可以统计你推送的数据被多少人看到了，不过事情到这里还没有结束，通过rails server来上传图片效率是很低的，你应该将这项任务交给web server。以nginx服务器为例，它提供了X-Accel-Redirect选项，负责静态文件的上传。</p>

<p>首先，修改nginx的配置文件，将/assets路径加入到X-Accel-Redirect</p>

<div class="highlight"><pre><code class="ruby"><span class="n">location</span><span class="sr"> /assets {</span>
<span class="sr">  root /</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">staging</span><span class="o">/</span><span class="n">current</span><span class="o">/</span><span class="kp">public</span><span class="p">;</span>
  <span class="n">internal</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>


<p>这段配置的作用是，如果X-Accel-Redirect指定的路径为/assets/image.png，那么nginx会去寻找/var/www/staging/current/public/assets/image.png文件并上传</p>

<p>然后要将推送到facebook的图片或视频路径由assets/1改为facebook_assets/1，避免和X-Accel-Redirect冲突。</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">FacebookAssetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">asset</span> <span class="o">=</span> <span class="no">Asset</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="c1"># add logic to increment asset show count</span>

    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;X-Accel-Redirect&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">attachment</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="ss">:small</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
    <span class="n">render</span> <span class="ss">:nothing</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>


<p>可以看到，只需要在reponse header中增加X-Accel-Redirect即可，render :nothing = true表示rails server不处理图片的上传。nginx看到response header中有X-Accel-Redirect选项，就到/var/www/staging/current/public目录下面去寻找相应的图片并上传。</p>

<p>Lighttpd和Apache2则可以通过X-Sendfile选项来完成同样的事情。</p>

      <div class="clear"></div>
    </div>
    <p class="alt-font tight">
      Posted in&nbsp;
      
      <a href="/categories/Rails" title="Rails" rel="category tag">Rails</a>
      
      <a href="/categories/Facebook" title="Facebook" rel="category tag">Facebook</a>
      
      <a href="/categories/Nginx" title="Nginx" rel="category tag">Nginx</a>
      
    </p>
    <p class="comments-link">
      <a href='/2010/05/20/tracking-image-views-in-the-external-system/#disqus_thread'>Comments</a>
    </p>
    <p class="by-line">
      <span class="date full-date">
        <abbr class="published" title="Thu May 20 00:00:00 -0700 2010">20 May 2010</abbr>
      </span>
    </p>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full">
    <h1 class="entry-title">
      <a href="/2010/05/15/ruby1-9-chinese-problem/" title="Ruby1.9的中文问题" rel="bookmark">Ruby1.9的中文问题</a>
    </h1>
    <div class="entry-content full-content">
      <p>今天在ruby 1.9.1的环境下试了一下1.8.7下面写的一段代码，结果报错：syntax error, unexpected $end, expecting '}'，查看了一下代码，如下</p>

<div class="highlight"><pre><code class="ruby"><span class="no">STATUS</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;400&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;在线&quot;</span><span class="p">,</span>
  <span class="s2">&quot;300&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;离开&quot;</span><span class="p">,</span>
  <span class="s2">&quot;600&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;繁忙&quot;</span><span class="p">,</span>
  <span class="s2">&quot;0&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;脱机&quot;</span>
<span class="p">}</span>
</code></pre>
</div>


<p>语法完全没有问题，判断是中文导致的问题，奇怪的是在1.8.7下面运行正常。google了一下，原来只要在文件开头加上coding就可以了</p>

<div class="highlight"><pre><code class="ruby"><span class="c1">#coding: utf-8</span>
</code></pre>
</div>




      <div class="clear"></div>
    </div>
    <p class="alt-font tight">
      Posted in&nbsp;
      
      <a href="/categories/Ruby" title="Ruby" rel="category tag">Ruby</a>
      
    </p>
    <p class="comments-link">
      <a href='/2010/05/15/ruby1-9-chinese-problem/#disqus_thread'>Comments</a>
    </p>
    <p class="by-line">
      <span class="date full-date">
        <abbr class="published" title="Sat May 15 00:00:00 -0700 2010">15 May 2010</abbr>
      </span>
    </p>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full">
    <h1 class="entry-title">
      <a href="/2010/05/13/write-to-resque-extension/" title="为resque写扩展" rel="bookmark">为resque写扩展</a>
    </h1>
    <div class="entry-content full-content">
      <p>resque是基于redis的ruby类库，用于创建后台任务，把这些后台任务放在多个队列中去，之后在处理它们。github就是使用resque来处理它们的后台任务的。</p>

<p>对于需要长时间处理的任务，比如发送email，发tweet，图片resize等等，都是resque的用武之地。默认resque就是将任务加到redis的队列中去，然后定时取出来去处理，实际项目中我们往往需要对其增加额外的扩展，比如你需要增加日志功能，增加处理次数的限制，这个时候就可以给resque写一个plugin，就像rails的plugin一样。</p>

<p>resque定义了非常良好的HOOK，使得为其写扩展变得更加容易。</p>

<p>resque采取的是每隔n秒从队列中获取一个任务，然后fork一个子进程来执行这个任务。resque定义了before_fork, after_fork, before_perform, after_perform, around_perform, on_failure几个hook，执行顺序如下</p>

<ol>
<li><p>before_fork</p></li>
<li><p>fork</p></li>
<li><p>after_fork</p></li>
<li><p>before_perform</p></li>
<li><p>around_perform</p></li>
<li><p>perform</p></li>
<li><p>around_perfomr</p></li>
<li><p>after_perform</p></li>
</ol>


<p>还有就是发生错误的时候，on_failure会被执行。</p>

<p>再给一个我写的resque-restriction插件的实例</p>

<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">before_perform_restriction</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="n">settings</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">period</span><span class="p">,</span> <span class="n">number</span><span class="o">|</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">redis_key</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">get_restrict</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">nil?</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
      <span class="n">set_restrict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">seconds</span><span class="p">(</span><span class="n">period</span><span class="p">),</span> <span class="n">number</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="n">value</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&lt;=</span> <span class="mi">0</span>
      <span class="no">Resque</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;restriction&quot;</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="nb">to_s</span><span class="p">,</span> <span class="ss">:args</span> <span class="o">=&gt;</span> <span class="n">args</span>
      <span class="k">raise</span> <span class="no">Resque</span><span class="o">::</span><span class="no">Job</span><span class="o">::</span><span class="no">DontPerform</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">after_perform_restriction</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="n">settings</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">period</span><span class="p">,</span> <span class="n">number</span><span class="o">|</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">redis_key</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
    <span class="no">Resque</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">decrby</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>


<p>before_perform_restriction检查任务在一个时间段执行的次数，如果执行次数超过规定，抛出Resque::Job::DontPerform异常，它将终止该任务继续执行。</p>

<p>after_perform_restriction则在任务执行之后，将计数器减一。</p>

<p>可以看出，resque作为一个后台任务的框架，其api设计非常良好，很容易对其进行扩展，应该多学习学习。</p>

      <div class="clear"></div>
    </div>
    <p class="alt-font tight">
      Posted in&nbsp;
      
      <a href="/categories/Rails" title="Rails" rel="category tag">Rails</a>
      
      <a href="/categories/Resque" title="Resque" rel="category tag">Resque</a>
      
      <a href="/categories/Ruby" title="Ruby" rel="category tag">Ruby</a>
      
    </p>
    <p class="comments-link">
      <a href='/2010/05/13/write-to-resque-extension/#disqus_thread'>Comments</a>
    </p>
    <p class="by-line">
      <span class="date full-date">
        <abbr class="published" title="Thu May 13 00:00:00 -0700 2010">13 May 2010</abbr>
      </span>
    </p>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full">
    <h1 class="entry-title">
      <a href="/2010/05/02/git-for-hostmonster/" title="git for hostmonster" rel="bookmark">git for hostmonster</a>
    </h1>
    <div class="entry-content full-content">
      <p>前段时间对网站做了些更新，于是在本地修改了代码，再git push，谁知却得到bash: git-receive-pack: command not found的error，我的git repository是放在hostmonster服务器上面的，之前都是正常的，于是提交ticket给hostmonster的support，得到的答复是他们升级的openssh，通过git+ssh不会再读取.bashrc或.ssh/environment文件，也就是说通过git+ssh没有办法修改PATH了。</p>

<p>没办法了，只能手动将命令的路径补全了，对于git pull/git ps来说，只需要在输入命令的时候增加参数，比如</p>

<div class="highlight"><pre><code class="bash">git clone --upload-pack<span class="o">=</span>/home1/huangzhi/git/bin/git-upload-pack
git push --receive-pack<span class="o">=</span>/home1/huangzhi/git/bin/git-receive-pack
</code></pre>
</div>


<p>不过每次都输入参数实在麻烦，直接写到配置文件.git/config</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>remote <span class="s2">&quot;origin&quot;</span><span class="o">]</span>
<span class="nv">uploadpack</span><span class="o">=</span>/home1/huangzhi/git/bin/git-upload-pack
<span class="nv">receivepack</span><span class="o">=</span>/home1/huangzhi/git/bin/git-receive-pack
</code></pre>
</div>


<p>然后就可以像以前一样git pull/git ps了。</p>

<p>还有一个问题，那就是capistrano。默认capistrano通过git ls-remote获取最新的commit id，通过git clone来获取最新文件，但是这些命令都没有办法设置upload-pack和receive-pack参数，没办法，只能修改默认的方法定义。</p>

<p>首先是git ls-remote</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s1">&#39;capistrano/recipes/deploy/scm/base&#39;</span>
<span class="o">::</span><span class="no">Capistrano</span><span class="o">::</span><span class="no">Deploy</span><span class="o">::</span><span class="no">SCM</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
  <span class="n">alias_method</span> <span class="ss">:origin_scm</span><span class="p">,</span> <span class="ss">:scm</span>
  <span class="k">def</span> <span class="nf">scm</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;git&quot;</span> <span class="ow">and</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;ls-remote&quot;</span>
      <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;ls-remote --upload-pack=/home1/huangzhi/git/bin/git-upload-pack&quot;</span>
    <span class="k">end</span>
    <span class="n">origin_scm</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>


<p>当命令为git ls-remote的时候，额外加入参数upload-pack</p>

<p>再就是git checkout</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s1">&#39;capistrano/recipes/deploy/scm/git&#39;</span>
<span class="o">::</span><span class="no">Capistrano</span><span class="o">::</span><span class="no">Deploy</span><span class="o">::</span><span class="no">SCM</span><span class="o">::</span><span class="no">Git</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">checkout</span><span class="p">(</span><span class="n">revision</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span>
    <span class="n">git</span>    <span class="o">=</span> <span class="s2">&quot;/home1/huangzhi/git/bin/git&quot;</span>
    <span class="n">remote</span> <span class="o">=</span> <span class="n">origin</span>

    <span class="n">args</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="n">args</span>  <span class="s2">&quot;-o </span><span class="si">#{</span><span class="n">remote</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">unless</span> <span class="n">remote</span> <span class="o">==</span> <span class="s1">&#39;origin&#39;</span>
    <span class="k">if</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">[</span><span class="ss">:git_shallow_clone</span><span class="o">]</span>
      <span class="n">args</span>  <span class="s2">&quot;--depth </span><span class="si">#{</span><span class="n">depth</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>

    <span class="n">execute</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">empty?</span>
      <span class="n">execute</span>  <span class="s2">&quot;</span><span class="si">#{</span><span class="n">git</span><span class="si">}</span><span class="s2"> clone --upload-pack=/home1/huangzhi/git/bin/git-upload-pack </span><span class="si">#{</span><span class="n">verbose</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">configuration</span><span class="o">[</span><span class="ss">:repository</span><span class="o">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">destination</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span>
      <span class="n">execute</span>  <span class="s2">&quot;</span><span class="si">#{</span><span class="n">git</span><span class="si">}</span><span class="s2"> clone --upload-pack=/home1/huangzhi/git/bin/git-upload-pack </span><span class="si">#{</span><span class="n">verbose</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">args</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">configuration</span><span class="o">[</span><span class="ss">:repository</span><span class="o">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">destination</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>

    <span class="c1"># checkout into a local branch rather than a detached HEAD</span>
    <span class="n">execute</span>  <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">destination</span><span class="si">}</span><span class="s2">  </span><span class="si">#{</span><span class="n">git</span><span class="si">}</span><span class="s2"> checkout </span><span class="si">#{</span><span class="n">verbose</span><span class="si">}</span><span class="s2"> -b deploy </span><span class="si">#{</span><span class="n">revision</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">configuration</span><span class="o">[</span><span class="ss">:git_enable_submodules</span><span class="o">]</span>
      <span class="n">execute</span>  <span class="s2">&quot;</span><span class="si">#{</span><span class="n">git</span><span class="si">}</span><span class="s2"> submodule </span><span class="si">#{</span><span class="n">verbose</span><span class="si">}</span><span class="s2"> init&quot;</span>
      <span class="n">execute</span>  <span class="s2">&quot;</span><span class="si">#{</span><span class="n">git</span><span class="si">}</span><span class="s2"> submodule </span><span class="si">#{</span><span class="n">verbose</span><span class="si">}</span><span class="s2"> sync&quot;</span>
      <span class="n">execute</span>  <span class="s2">&quot;</span><span class="si">#{</span><span class="n">git</span><span class="si">}</span><span class="s2"> submodule </span><span class="si">#{</span><span class="n">verbose</span><span class="si">}</span><span class="s2"> update&quot;</span>
    <span class="k">end</span>

    <span class="n">execute</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>


<p>这个我没有找个比较优雅的方式，只能直接覆盖原来的方法定义，并在git clone的命令中加入upload-pack。</p>

<p>还有就是当capistrano执行远程命令的时候，同样没有合适的environments，比如执行rake db:migrate的时候，所以需要修改默认的rake命令</p>

<div class="highlight"><pre><code class="ruby"><span class="n">set</span> <span class="ss">:rake</span><span class="p">,</span> <span class="s2">&quot;source /home1/huangzhi/.bashrc; rake&quot;</span>
</code></pre>
</div>


<p>这样当执行rake命令执行，首先读取.bashrc，设置合适的environments，然后再执行rake命令。</p>

<p>到此为止，一切又恢复了正常。</p>

      <div class="clear"></div>
    </div>
    <p class="alt-font tight">
      Posted in&nbsp;
      
      <a href="/categories/Git" title="Git" rel="category tag">Git</a>
      
      <a href="/categories/Capistrano" title="Capistrano" rel="category tag">Capistrano</a>
      
      <a href="/categories/Hostmonster" title="Hostmonster" rel="category tag">Hostmonster</a>
      
    </p>
    <p class="comments-link">
      <a href='/2010/05/02/git-for-hostmonster/#disqus_thread'>Comments</a>
    </p>
    <p class="by-line">
      <span class="date full-date">
        <abbr class="published" title="Sun May 02 00:00:00 -0700 2010">02 May 2010</abbr>
      </span>
    </p>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>

  <div class="full">
    <h1 class="entry-title">
      <a href="/2010/04/21/to-select-and-input-type-file-tag-to-add-style/" title="为select和input type=file标签添加样式" rel="bookmark">为select和input type=file标签添加样式</a>
    </h1>
    <div class="entry-content full-content">
      <p>select和input type=file两个都是html标签，但是它们在不同的浏览器上显示是完全不同，对于那些对UI要求非常高的网站来说，这是不可接受的。由于这两个标签的样式是由浏览器实现的，所以要想完全通过css来统一样式几乎是不可能的，所以我们这里需要借助javascript的帮助。</p>

<p>看上去这个应该由两个标签组成，左边是一个text field，右边是一个上传的按钮，要想在所有的浏览器上都把input type=file做成这个样子好像没这个可能，可以想到的办法就是设置两个层，下面的层由一个text field和一个按钮组成，上面是一个透明的input type=file的层，高度和宽度正好覆盖下面的层就可以了。</p>

<p>我是借助 javascript来生成下面的那个层</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;form input[type=file]&#39;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="nx">elem</span><span class="p">).</span><span class="nx">parent</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;div class=&#39;fakefile&#39;&gt;&lt;input type=&#39;text&#39;&gt;&lt;div class=&#39;browser_button&#39;&gt;&lt;/div&gt;&lt;/div&gt;&quot;</span><span class="p">));</span>
  <span class="nx">$</span><span class="p">(</span><span class="nx">elem</span><span class="p">).</span><span class="nx">change</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">parent</span><span class="p">().</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;input[type=text]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>


<p>这里fakefile就是下面的那个层，<code>&lt;div  class="browser_button"&gt;&lt;/div&gt;</code>是通过css_sprite得到的按钮图片（最近使用 css_sprite到了偏执的状态）。然后就是通过css来区分上下两个层</p>

<div class="highlight"><pre><code class="css"><span class="nc">.file</span> <span class="p">{</span>
  <span class="k">width</span><span class="o">:</span> <span class="m">209px</span><span class="p">;</span>
  <span class="k">height</span><span class="o">:</span> <span class="m">28px</span><span class="p">;</span>
  <span class="k">position</span><span class="o">:</span> <span class="k">relative</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.file</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="nt">file</span><span class="o">]</span> <span class="p">{</span>
  <span class="k">z-index</span><span class="o">:</span> <span class="m">2</span><span class="p">;</span>
  <span class="k">width</span><span class="o">:</span> <span class="m">278px</span><span class="p">;</span>
  <span class="k">opacity</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="n">filter</span><span class="o">:</span> <span class="n">alpha</span><span class="p">(</span><span class="k">opacity</span><span class="o">:</span> <span class="m">0</span><span class="p">);</span>
  <span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="k">opacity</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="k">cursor</span><span class="o">:</span> <span class="k">pointer</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.file</span> <span class="nt">div</span><span class="nc">.fakefile</span> <span class="p">{</span>
  <span class="k">z-index</span><span class="o">:</span> <span class="m">1</span><span class="p">;</span>
  <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
  <span class="k">top</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="k">left</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.file</span> <span class="nt">div</span><span class="nc">.fakefile</span> <span class="nt">input</span> <span class="p">{</span>
  <span class="k">width</span><span class="o">:</span> <span class="m">207px</span><span class="p">;</span>
  <span class="k">height</span><span class="o">:</span> <span class="m">28px</span><span class="p">;</span>
  <span class="k">border</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="m">#c1c1c1</span><span class="p">;</span>
  <span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">3px</span><span class="p">;</span>
  <span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">3px</span><span class="p">;</span> <span class="p">}</span>
<span class="nc">.file</span> <span class="nt">div</span><span class="nc">.fakefile</span> <span class="nc">.browser_button</span> <span class="p">{</span>
  <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
  <span class="k">top</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="k">left</span><span class="o">:</span> <span class="m">207px</span><span class="p">;</span> <span class="p">}</span>
</code></pre>
</div>


<p>input  type=file的z-index为2，.fakefile的z-index为1，表示fakefile为下面的层，input  type=file为上面的层。input type=file的opacity设置为0，表示input  type=file为透明的，通过position: absolute可以将两个层完全重叠。这样做出来的input  type=file就和之前的图片一模一样了。</p>

<p>对于select标签的样式修改也可以用相同的办法进行处理。</p>

      <div class="clear"></div>
    </div>
    <p class="alt-font tight">
      Posted in&nbsp;
      
      <a href="/categories/css" title="css" rel="category tag">css</a>
      
      <a href="/categories/javascript" title="javascript" rel="category tag">javascript</a>
      
      <a href="/categories/html" title="html" rel="category tag">html</a>
      
    </p>
    <p class="comments-link">
      <a href='/2010/04/21/to-select-and-input-type-file-tag-to-add-style/#disqus_thread'>Comments</a>
    </p>
    <p class="by-line">
      <span class="date full-date">
        <abbr class="published" title="Wed Apr 21 00:00:00 -0700 2010">21 Apr 2010</abbr>
      </span>
    </p>
    <div class="clear"></div>
  </div>
  <div class="rule"><hr/></div>


<div class="pagination">
  <span class="previous">
    
      
      <a href="/page5/" title="Previous Page">&laquo; Previous</a>
      
    
  </span>
  <span class="next">
    
    <a href="/page7/" title="Next Page">Next &raquo;</a>
    
  </span>
</div>
<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=flyerhzm"></script>

        </div>
        <div id="sidebar">
          <div id="carrington-subscribe" class="widget">
            <h2 class="widget-title">Subscribe</h2>
            <a class="feed alignright" title="RSS 2.0 feed for posts" rel="alternate" href="http://feeds.feedburner.com/richard-huang">
              <img src="/images/rss-button.gif" alt="latest posts" title="latest posts">
            </a>
          </div>
          <div id="carrington-about" class="widget">
            <div class="about">
              <h2 class="widget-title">About</h2>
              <p>My name is Richard Huang, a Rubyist and open source advocate.</p>
              <a class="more" href="/about.html">more →</a>
            </div>
          </div>
          <div id="carrington-speaker" class="widget">
            <img src="/images/160x160speaker.png">
          </div>
          <div id="primary-sidebar">
            <div class="widget">
              <h2 class="widget-title">Categories</h2>
              <ul>
                
                <li><a href="/categories/jekyll">jekyll (1)</a></li>
                
                <li><a href="/categories/mongodb">mongodb (2)</a></li>
                
                <li><a href="/categories/GAE">GAE (1)</a></li>
                
                <li><a href="/categories/Linux">Linux (4)</a></li>
                
                <li><a href="/categories/html">html (2)</a></li>
                
                <li><a href="/categories/Java Web">Java Web (3)</a></li>
                
                <li><a href="/categories/Resque">Resque (1)</a></li>
                
                <li><a href="/categories/Rack">Rack (1)</a></li>
                
                <li><a href="/categories/RubyGems">RubyGems (7)</a></li>
                
                <li><a href="/categories/rake">rake (1)</a></li>
                
                <li><a href="/categories/php">php (2)</a></li>
                
                <li><a href="/categories/disqus">disqus (1)</a></li>
                
                <li><a href="/categories/Less">Less (1)</a></li>
                
                <li><a href="/categories/ActiveRecord">ActiveRecord (5)</a></li>
                
                <li><a href="/categories/Rails">Rails (35)</a></li>
                
                <li><a href="/categories/css">css (9)</a></li>
                
                <li><a href="/categories/sql">sql (1)</a></li>
                
                <li><a href="/categories/maven">maven (1)</a></li>
                
                <li><a href="/categories/Vim">Vim (1)</a></li>
                
                <li><a href="/categories/Ruby">Ruby (33)</a></li>
                
                <li><a href="/categories/Presentation">Presentation (7)</a></li>
                
                <li><a href="/categories/contact-list">contact-list (6)</a></li>
                
                <li><a href="/categories/Java">Java (9)</a></li>
                
                <li><a href="/categories/Github">Github (1)</a></li>
                
                <li><a href="/categories/flex">flex (4)</a></li>
                
                <li><a href="/categories/Rails Plugins">Rails Plugins (12)</a></li>
                
                <li><a href="/categories/passenger">passenger (1)</a></li>
                
                <li><a href="/categories/Sinatra">Sinatra (1)</a></li>
                
                <li><a href="/categories/Nginx">Nginx (2)</a></li>
                
                <li><a href="/categories/Facebook">Facebook (2)</a></li>
                
                <li><a href="/categories/Android">Android (2)</a></li>
                
                <li><a href="/categories/Rspec">Rspec (3)</a></li>
                
                <li><a href="/categories/javascript">javascript (4)</a></li>
                
                <li><a href="/categories/Life">Life (19)</a></li>
                
                <li><a href="/categories/git">git (1)</a></li>
                
                <li><a href="/categories/Seo">Seo (1)</a></li>
                
                <li><a href="/categories/Git">Git (4)</a></li>
                
                <li><a href="/categories/Ldap">Ldap (1)</a></li>
                
                <li><a href="/categories/mongoid">mongoid (7)</a></li>
                
                <li><a href="/categories/webrick">webrick (3)</a></li>
                
                <li><a href="/categories/msn">msn (1)</a></li>
                
                <li><a href="/categories/Capistrano">Capistrano (3)</a></li>
                
                <li><a href="/categories/redis">redis (1)</a></li>
                
                <li><a href="/categories/uml">uml (1)</a></li>
                
                <li><a href="/categories/Hostmonster">Hostmonster (5)</a></li>
                
                <li><a href="/categories/jquery">jquery (1)</a></li>
                
                <li><a href="/categories/Twitter">Twitter (2)</a></li>
                
                <li><a href="/categories/HTTP">HTTP (4)</a></li>
                
              </ul>
            </div>
          </div>
          <div id="secondary-sidebar">
            <div class="widget">
              <h2 class="widget-title">Recent Posts</h2>
              <ul>
                
                <li>
                  <a href="/2011/12/13/rake-arguments/" title="rake arguments" rel="bookmark">rake arguments</a>
                </li>
                
                <li>
                  <a href="/2011/12/12/passenger-with-redis/" title="passenger with redis" rel="bookmark">passenger with redis</a>
                </li>
                
                <li>
                  <a href="/2011/11/14/avoid-committing-git-conflicts/" title="avoid committing git conflicts" rel="bookmark">avoid committing git conflicts</a>
                </li>
                
                <li>
                  <a href="/2011/11/06/after_commit/" title="after_commit" rel="bookmark">after_commit</a>
                </li>
                
                <li>
                  <a href="/2011/10/31/reset_counter-in-rails/" title="reset_counter in rails" rel="bookmark">reset_counter in rails</a>
                </li>
                
                <li>
                  <a href="/2011/10/21/rspec-filter/" title="use rspec filter to speed up tests" rel="bookmark">use rspec filter to speed up tests</a>
                </li>
                
                <li>
                  <a href="/2011/07/17/rubykaigi-presentation/" title="rubykaigi presentation" rel="bookmark">rubykaigi presentation</a>
                </li>
                
                <li>
                  <a href="/2011/03/27/beijing-ruby-event/" title="beijing ruby线下活动" rel="bookmark">beijing ruby线下活动</a>
                </li>
                
                <li>
                  <a href="/2011/03/22/upgrade-mongoid-multiple-database/" title="Upgrade Mongoid - Multiple databases" rel="bookmark">Upgrade Mongoid - Multiple databases</a>
                </li>
                
                <li>
                  <a href="/2011/03/21/upgrade-mongoid-update_attribute/" title="Upgrade Mongoid - update_attribute" rel="bookmark">Upgrade Mongoid - update_attribute</a>
                </li>
                
              </ul>
              <div class="clear"></div>
            </div>
            <div class="widget">
              <h2 class="widget-title">Archives</h2>
              <ul>
                
                <li>
                  <a href="/2011/12">December 2011</a> (2 posts)
                </li>
                
                <li>
                  <a href="/2011/11">November 2011</a> (2 posts)
                </li>
                
                <li>
                  <a href="/2011/10">October 2011</a> (2 posts)
                </li>
                
                <li>
                  <a href="/2011/07">July 2011</a> (1 posts)
                </li>
                
                <li>
                  <a href="/2011/03">March 2011</a> (5 posts)
                </li>
                
                <li>
                  <a href="/2011/01">January 2011</a> (6 posts)
                </li>
                
                <li>
                  <a href="/2010/12">December 2010</a> (1 posts)
                </li>
                
                <li>
                  <a href="/2010/08">August 2010</a> (1 posts)
                </li>
                
                <li>
                  <a href="/2010/07">July 2010</a> (1 posts)
                </li>
                
                <li>
                  <a href="/2010/06">June 2010</a> (4 posts)
                </li>
                
                <li>
                  <a href="/2010/05">May 2010</a> (4 posts)
                </li>
                
                <li>
                  <a href="/2010/04">April 2010</a> (4 posts)
                </li>
                
                <li>
                  <a href="/2010/03">March 2010</a> (6 posts)
                </li>
                
                <li>
                  <a href="/2010/02">February 2010</a> (4 posts)
                </li>
                
                <li>
                  <a href="/2010/01">January 2010</a> (5 posts)
                </li>
                
                <li>
                  <a href="/2009/12">December 2009</a> (7 posts)
                </li>
                
                <li>
                  <a href="/2009/11">November 2009</a> (5 posts)
                </li>
                
                <li>
                  <a href="/2009/10">October 2009</a> (4 posts)
                </li>
                
                <li>
                  <a href="/2009/09">September 2009</a> (11 posts)
                </li>
                
                <li>
                  <a href="/2009/08">August 2009</a> (13 posts)
                </li>
                
                <li>
                  <a href="/2009/07">July 2009</a> (8 posts)
                </li>
                
                <li>
                  <a href="/2009/06">June 2009</a> (9 posts)
                </li>
                
                <li>
                  <a href="/2009/05">May 2009</a> (7 posts)
                </li>
                
                <li>
                  <a href="/2009/04">April 2009</a> (7 posts)
                </li>
                
                <li>
                  <a href="/2009/01">January 2009</a> (2 posts)
                </li>
                
                <li>
                  <a href="/2008/12">December 2008</a> (3 posts)
                </li>
                
                <li>
                  <a href="/2008/11">November 2008</a> (4 posts)
                </li>
                
                <li>
                  <a href="/2008/08">August 2008</a> (5 posts)
                </li>
                
                <li>
                  <a href="/2008/07">July 2008</a> (1 posts)
                </li>
                
                <li>
                  <a href="/2008/06">June 2008</a> (1 posts)
                </li>
                
                <li>
                  <a href="/2008/04">April 2008</a> (1 posts)
                </li>
                
                <li>
                  <a href="/2008/03">March 2008</a> (6 posts)
                </li>
                
                <li>
                  <a href="/2008/02">February 2008</a> (2 posts)
                </li>
                
              </ul>
              <div class="clear"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="footer" class="section">
      <div class="wrapper">
        <a id="generator-link">
          Proudly powered by
          <a href="https://github.com/mojombo/jekyll" rel="generator">Jekyll</a>
          and
          <a href="http://carringtontheme.com" title="Carrington theme for WordPress">Carrington</a>
      </div>
      <div id="developer-link">
      </div>
    </div>
    <a href="http://github.com/flyerhzm"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://assets2.github.com/img/e6bef7a091f5f3138b8cd40bc3e114258dd68ddf?repo=&url=http%3A%2F%2Fs3.amazonaws.com%2Fgithub%2Fribbons%2Fforkme_right_red_aa0000.png&path=" alt="Fork me on GitHub"></a>
    <script type="text/javascript">
      var disqus_shortname = 'richard-huang';

      (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
      }());
    </script>
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      try {
        var pageTracker = _gat._getTracker("UA-8561975-1");
        pageTracker._trackPageview();
      } catch(err) {}
    </script>
  </body>
</html>
