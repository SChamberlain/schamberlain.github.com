<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <title>
    
    Recology, R/etc.
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Abril+Fatface">

  <link rel="stylesheet" href="/public/css/bootstrap/css/bootstrap.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/favicon.ico">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0f layout-reverse">

    <header class="masthead">
      <div class="masthead-inner">
        <h1>Recology</h1>
        <!-- <h1> <a href="http://recology.info/">Recology</a></h1> -->
        <p class="lead">R/etc.</p>

        <div class="colophon">
          <ul class="colophon-links">
            <li>
              <a href="/"><i class="fa fa-home fa-lg"></i></a>&nbsp;
              <a href="/about"><i class="fa fa-info-circle fa-lg"></i></a>&nbsp;
              <a href="/archives"><i class="fa fa-archive fa-lg"></i></a>&nbsp;
              <a href="/rresources"><i class="fa fa-book fa-lg"></i></a>&nbsp;
              <a href="http://rforcats.net/" rel><i class="fa fa-graduation-cap fa-lg"></i></a>&nbsp;
              <a href="/feed.xml"><i class="fa fa-rss fa-lg"></i></a>&nbsp;
              <a href="https://twitter.com/sckottie"><i class="fa fa-twitter fa-lg"></i></a>&nbsp;
              <a href="/fork"><i class="fa fa-spinner fa-lg"></i></a>
            </li>
          </ul>
          <!-- <small><a href="https://github.com/mdo/hyde">Hyde</a> from <a href="https://twitter.com/mdo" target="_blank">@mdo</a>.</small> -->
        </div>
      </div>
    </header>

    <div class="content container">
      <div class="posts">
  <a style="float:right;" href="/archives" data-toggle="tooltip" data-placement="bottom" title="Archives"><i class="fa fa-archive fa-lg"></i></a>
  <a style="float:right;" href="/tags"><i class="fa fa-tags fa-lg"></i></a>&nbsp;
  
  <div class="post">
    <h1>
      <a href="/2012/10/R2G2-package/">
        Displaying Your Data in Google Earth Using R2G2
      </a>
    </h1>

    <span class="post-date">24 Oct 2012</span>

    Have you ever wanted to easily visualize your ecology data in [Google Earth][googleearth]?  [R2G2][r2g2] is a new package for R, available via [R CRAN][rcran] and formally described in [this Molecular Ecology Resources article][MERarticle], which provides a user-friendly bridge between R and the Google Earth interface.  Here, we will provide a brief introduction to the package, including a short tutorial, and then encourage you to try it out with your own data!

[Nils Arrigo][nils], with some help from [Loren Albert][loren], [Mike Barker][mike], and Pascal Mickelson (one of the contributors to [Recology][recology]), has created a set of R tools to generate KML files to view data with geographic components.  Instead of just telling you what the tools can do, though, we will show you a couple of examples using publically available data.  Note: a number of individual files are linked to throughout the tutorial below, but just in case you would rather download all the tutorial files in one go, have at it ([tutorial zip file][tutorialfile]).

Among the basic tools in [R2G2][r2g2] is the ability to place features—like dots, shapes, or images (including plots you produced in R)— that represent discrete observations at specific geographical locations.  For example, in the figure below, we show the migratory path of a particular turkey vulture in autumn of three successive years (red = 2009; blue = 2010; green = 2011).  


<div align="center">
<img src="/public/img/R2G2tutorial/Vulture_Path.jpg" alt="Google Earth image with three successive years of a particular turkey vulture's migration" width="800"><br>
<small>Google Earth imagery showing migratory path of a particular turkey vulture in 2009, 2010, and 2011.</small>
</div>  


We use the *PolyLines2GE* function that is part of [R2G2][r2g2] to create line segments between the geographical coordinates which have been obtained from a turkey vulture tagged with a transponder (data accessed via the [Movebank Data Repository][movebank] and is from the [Turkey Vulture Acopian Center USA GPS][turkeyvulturestudy]).  The *PolyLines2GE* function looks like the following:  

{% highlight r %}
PolyLines2GE(coords = vulture_path[,2:3],  
			nesting = vulture_path[,1],  
			colors = "auto",  
			goo = "Vulture_Path.kml",  
			maxAlt = 1e4,  
			fill = FALSE,  
			closepoly = FALSE,  
			lwd = 2,  
			extrude = 0)
{% endhighlight %}  

It expects to receive an array ("coords") containing latitude and longitude coordinates in decimal degrees. Additionally, each individual coordinate has a flag associated with it ("nesting") so that each data series can be distinguished.  Illustrating what you need is easier than explaining:
{% highlight text %}
nesting longitude latitude
1	long1A		lat1A
1	long1B		lat1B
1	long1C		lat1C
2	long2A		lat2A
2	long2B		lat2B
3	long3A		lat3A
3	long3B		lat3B
3	long3C		lat3C
{% endhighlight %}
Feeding the columns of this array to the function results in three differently colored lines:  the first would connect the coordinates 1A-1B-1C, while the second would connect 2A-2B, and the third would connect 3A-3B-3C.  The only other user-defined input that is strictly necessary is the output file name ("Vulture_Path.kml" in this case).  The other options—which allow you control of the appearance of the lines and of the altitude at which your line displays in Google Earth—have reasonable defaults that are well-documented in the function definition itself.  Check out this example in Google Earth [by downloading the KML file][vultureKML].  Alternatively, [download the annotated R script][vultureR] and generate the KML file for yourself.

Now, let's say you wanted to get a sense of the range and abundance of two congeneric species.  In this second example, we use the *Hist2GE* function to create a histogram—overlaid on the surface of the earth—which shows the species distribution of *Mimulus lewisii* (red) and *Mimulus nasutus* (blue) in North America.  


<div align="center">
<img src="/public/img/R2G2tutorial/Mimulus_Distribution.jpg" alt="Google Earth image showing the distribution of Mimulus in North America" width="800"><br>
<small>Google Earth imagery showing the species distribution of <em>Mimulus lewisii</em> and <em>Mimulus nasutus</em></small>
</div>  


As you might expect, each polygon represents an occurrence of the species in question, while the height of the polygon represents the abundance of the species at that geographic location.  Species occurring within a particular distance of each other have been grouped together for the histogram.  For this example, we retrieve data from the [GBIF][gbif] database from within R (see the example code for how that is done).  Inputs to the Hist2GE function are:
{% highlight r %}
Hist2GE(coords = MyCompleteData[, 8:7],  
		species = MyCompleteData[, 1],  
		grid = grid10000,  
		goo = "Mimulus",  
		nedges = 6,  
		orient = 45,  
		maxAlt = 1e4)
{% endhighlight %}
As in the first example, the function expects to receive an array containing the longitude and latitude ("coords"), a vector distinguishing individual observations ("species"), and an output file name ("goo").  In this case, however, we also need to specify the size of the grid we will use to group observations together to construct the histogram.  Several pre-defined grid sizes are included in the package to do this grouping; these all cover large geographic areas and therefore must account for the curvature of the earth.  Here is a list of these pre-defined grids:

<table border="1">
    <tr><th>Grid Name</th><th>Approximate Area of Grid Division </th></tr>
    <tr><td>grid20000</td><td>25,500 sq. km</td></tr>
    <tr><td>grid10000</td><td>51,000 sq. km</td></tr>
    <tr><td>grid5000</td><td>102,000 sq. km</td></tr>
    <tr><td>grid500</td><td>1,020,000 sq. km</td></tr>
    <tr><td>grid50</td><td>10,200,000 sq. km</td></tr>
</table>  

For smaller geographic areas (less than 25,000 square kilometers, or an area of about 158 km per side), you can customize the grid size by specifying the bounds of your region of interest in decimal degrees, as well as the coarseness of the grid within that region.  While it is possible to use this custom grid definition for larger sizes, beware that not all areas defined thusly will be of equal size due to the earth's curvature (obviously the bigger you go, the worse it gets...).  Finally, you again have control over the display parameters of the histogram.  In particular, the maximum altitude ("maxAlt") controls how high the tallest bar in the histogram will go.  Here is [the resulting KML file][mimulusKML], as well as [the annotated R script][mimulusR] so you can further explore the example.

More complex visual representations are also possible using [R2G2][r2g2].  For instance, you can also create contour plots or phylogenies overlaid directly on the surface of the earth.  We included a couple examples of this type in [our Molecular Ecology Resources article][MERarticle], and if the response seems good, we may post a follow up tutorial showing how we went about creating those examples.

It is our sincere hope that you will use the tools in [R2G2][r2g2] to more effectively visualize the geographical aspects of your data.  In particular, we are excited about the potential for incorporating [R2G2][r2g2] into data analysis pipelines connecting analysis in R with data visualization and exploration in Google Earth.  Ultimately, the inclusion of KML files as supplementary materials to journal articles should also enrich one's understanding of the data being presented!


<big><b>Note:  If you make something cool using <a href="http://cran.r-project.org/web/packages/R2G2/index.html">R2G2</a>, please post a link to your KML file in the comments; we would love to see!</b></big>


Citation information for [R2G2][r2g2]:  
*Arrigo, N., Albert, L. P., Mickelson, P. G. and Barker, M. S. (2012), Quantitative visualization of biological data in Google Earth using R2G2, an R CRAN package. Molecular Ecology Resources. doi: 10.1111/1755-0998.12012*

[googleearth]: http://earth.google.com
[rcran]: http://cran.r-project.org/
[MERarticle]: http://onlinelibrary.wiley.com/doi/10.1111/1755-0998.12012/abstract
[nils]: http://barkerlab.net/nils.html
[loren]: http://portal.environment.arizona.edu/students/profiles/loren-albert
[mike]: http://barkerlab.net/mike.html
[recology]: http://sckott.github.io/about.html
[gbif]: http://data.gbif.org/
[r2g2]: http://cran.r-project.org/web/packages/R2G2/index.html
[vultureKML]: /public/img/R2G2tutorial/Vulture_Path.kml
[vultureR]: /public/img/R2G2tutorial/Vulture_Path.R
[movebank]: http://movebank.org/
[turkeyvulturestudy]: http://movebank.org/movebank/#page%3Dstudies%2Cpath%3Dstudy481458
[mimulusKML]: /public/img/R2G2tutorial/Mimulus_Distribution.kml
[mimulusR]: /public/img/R2G2tutorial/Mimulus_Distribution.R
[tutorialfile]: /public/img/R2G2tutorial/R2G2tutorial.zip

  </div>
  
  <div class="post">
    <h1>
      <a href="/2012/10/get-taxa-downstream/">
        Getting taxonomic names downstream
      </a>
    </h1>

    <span class="post-date">16 Oct 2012</span>

    It can be a pain in the ass to get taxonomic names. For example, I sometimes need to get all the Class names for a set of species.  This is a relatively easy problem using the [ITIS API](http://www.itis.gov/ws_description.html) (example below).  

The much harder problem is getting all the taxonomic names downstream. ITIS doesn't provide an API method for this - well, they do ([`getHirerachyDownFromTSN`](http://www.itis.gov/ws_hierApiDescription.html#getHierarchyDn)), but it only provides direct children (e.g., the genera within a tribe - but it won't give all the species within each genus).  

So in the `taxize` package, we wrote a function called `downstream`, which allows you to get taxonomic names to any downstream point, e.g.:

+ get all Classes within Animalia,
+ get all Species within a Family
+ etc.

### Install packages.  You can get other packages from CRAN, but taxize is only on GitHub for now. 

{% highlight r linenos %}
# install_github('ritis', 'ropensci') # uncomment if not already installed
# install_github('taxize_', 'ropensci') # uncomment if not already
# installed
library(ritis)
library(taxize)
{% endhighlight %}


### Get upstream taxonomic names.

{% highlight r linenos %}
# Search for a TSN by scientific name
df <- searchbyscientificname("Tardigrada")
tsn <- df[df$combinedname %in% "Tardigrada", "tsn"]

# Get just one immediate higher taxonomic name
gethierarchyupfromtsn(tsn = tsn)
{% endhighlight %}



{% highlight text %}
  parentName parentTsn rankName  taxonName    tsn
1   Animalia    202423   Phylum Tardigrada 155166
{% endhighlight %}



{% highlight r linenos %}

# Get full hierarchy upstream from TSN
getfullhierarchyfromtsn(tsn = tsn)
{% endhighlight %}



{% highlight text %}
  parentName parentTsn rankName        taxonName    tsn
1                       Kingdom         Animalia 202423
2   Animalia    202423   Phylum       Tardigrada 155166
3 Tardigrada    155166    Class     Eutardigrada 155362
4 Tardigrada    155166    Class Heterotardigrada 155167
5 Tardigrada    155166    Class   Mesotardigrada 155358
{% endhighlight %}


### Get taxonomc names downstream.

{% highlight r linenos %}
# Get genera downstream fromthe Class Bangiophyceae
downstream(846509, "Genus")
{% endhighlight %}



{% highlight text %}
    tsn parentName parentTsn   taxonName rankId rankName
1 11531 Bangiaceae     11530      Bangia    180    Genus
2 11540 Bangiaceae     11530    Porphyra    180    Genus
3 11577 Bangiaceae     11530 Porphyrella    180    Genus
4 11580 Bangiaceae     11530 Conchocelis    180    Genus
{% endhighlight %}



{% highlight r linenos %}

# Get families downstream from Acridoidea
downstream(650497, "Family")
{% endhighlight %}



{% highlight text %}
      tsn parentName parentTsn      taxonName rankId rankName
1  102195 Acridoidea    650497      Acrididae    140   Family
2  650502 Acridoidea    650497     Romaleidae    140   Family
3  657472 Acridoidea    650497    Charilaidae    140   Family
4  657473 Acridoidea    650497   Lathiceridae    140   Family
5  657474 Acridoidea    650497     Lentulidae    140   Family
6  657475 Acridoidea    650497    Lithidiidae    140   Family
7  657476 Acridoidea    650497   Ommexechidae    140   Family
8  657477 Acridoidea    650497    Pamphagidae    140   Family
9  657478 Acridoidea    650497  Pyrgacrididae    140   Family
10 657479 Acridoidea    650497    Tristiridae    140   Family
11 657492 Acridoidea    650497 Dericorythidae    140   Family
{% endhighlight %}



{% highlight r linenos %}

# Get species downstream from Ursus
downstream(180541, "Species")
{% endhighlight %}



{% highlight text %}
     tsn parentName parentTsn        taxonName rankId rankName
1 180542      Ursus    180541  Ursus maritimus    220  Species
2 180543      Ursus    180541     Ursus arctos    220  Species
3 180544      Ursus    180541 Ursus americanus    220  Species
4 621850      Ursus    180541 Ursus thibetanus    220  Species
{% endhighlight %}


*********
#### Get the .Rmd file used to create this post [at my github account](https://github.com/sckott/sckott.github.com/tree/master/_drafts/2012-10-16-get-taxa-downstream.Rmd) - or [.md file](https://github.com/sckott/sckott.github.com/tree/master/_posts/2012-10-16-get-taxa-downstream.md).

#### Written in [Markdown](http://daringfireball.net/projects/markdown/), with help from [knitr](http://yihui.name/knitr/).

  </div>
  
  <div class="post">
    <h1>
      <a href="/2012/10/phylogenetic-tree-balance/">
        Exploring phylogenetic tree balance metrics
      </a>
    </h1>

    <span class="post-date">10 Oct 2012</span>

    I need to simulate balanced and unbalanced phylogenetic trees for some research I am doing.  In order to do this, I do rejection sampling: simulate a tree -> measure tree shape -> reject if not balanced or unbalanced __enough__.  But what is enough?  We need to define some cutoff value to determine what will be our set of balanced and unbalanced trees. 

### A function to calculate shape metrics, and a custom theme for plottingn phylogenies.

{% highlight r linenos %}
foo <- function(x, metric = "colless") {
    if (metric == "colless") {
        xx <- as.treeshape(x)  # convert to apTreeshape format
        colless(xx, "yule")  # calculate colless' metric
    } else if (metric == "gamma") {
        gammaStat(x)
    } else stop("metric should be one of colless or gamma")
}

theme_myblank <- function() {
    stopifnot(require(ggplot2))
    theme_blank <- ggplot2::theme_blank
    ggplot2::theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), plot.background = element_blank(), 
        axis.title.x = element_text(colour = NA), axis.title.y = element_blank(), 
        axis.text.x = element_blank(), axis.text.y = element_blank(), axis.line = element_blank(), 
        axis.ticks = element_blank())
}
{% endhighlight %}


### Simulate some trees

{% highlight r linenos %}
library(ape)
library(phytools)

numtrees <- 1000  # lets simulate 1000 trees
trees <- pbtree(n = 50, nsim = numtrees, ape = F)  # simulate 500 pure-birth trees with 100 spp each, ape = F makes it run faster
{% endhighlight %}


### Calculate Colless' shape metric on each tree

{% highlight r linenos %}
library(plyr)
library(apTreeshape)

colless_df <- ldply(trees, foo, metric = "colless")  # calculate metric for each tree
head(colless_df)
{% endhighlight %}



{% highlight text %}
       V1
1 -0.1761
2  0.2839
3  0.4639
4  0.9439
5 -0.6961
6 -0.1161
{% endhighlight %}



{% highlight r linenos %}

# Calculate the percent of trees that will fall into the cutoff for balanced and unbalanced trees
col_percent_low <- round(length(colless_df[colless_df$V1 < -0.7, "V1"])/numtrees, 2) * 100
col_percent_high <- round(length(colless_df[colless_df$V1 > 0.7, "V1"])/numtrees, 2) * 100
{% endhighlight %}


### Create a distribution of the metric values

{% highlight r linenos %}
library(ggplot2)

a <- ggplot(colless_df, aes(V1)) +  # plot histogram of distribution of values
	geom_histogram() + 
	theme_bw(base_size=18) + 
	scale_x_continuous(limits=c(-3,3), breaks=c(-3,-2,-1,0,1,2,3)) + 
	geom_vline(xintercept = -0.7, colour="red", linetype = "longdash") +
	geom_vline(xintercept = 0.7, colour="red", linetype = "longdash") +
	ggtitle(paste0("Distribution of Colless' metric for 1000 trees, cutoffs at -0.7 and 0.7 results in\n ", col_percent_low, "% (", numtrees*(col_percent_low/100), ") 'balanced' trees (left) and ", col_percent_low, "% (", numtrees*(col_percent_low/100), ") 'unbalanced' trees (right)")) +  
	labs(x = "Colless' Metric Value", y = "Number of phylogenetic trees") +
	theme(plot.title  = element_text(size = 16))

a
{% endhighlight %}

![center](/public/img/collesshist.png) 


### Create phylogenies representing balanced and unbalanced trees (using the custom theme)

{% highlight r linenos %}
library(ggphylo)

b <- ggphylo(trees[which.min(colless_df$V1)], do.plot = F) + theme_myblank()
c <- ggphylo(trees[which.max(colless_df$V1)], do.plot = F) + theme_myblank()

b
{% endhighlight %}

![center](/public/img/collessphylog.png) 


### Now, put it all together in one plot using some gridExtra magic.

{% highlight r linenos %}
library(gridExtra)

grid.newpage()
pushViewport(viewport(layout = grid.layout(1, 1)))
vpa_ <- viewport(width = 1, height = 1, x = 0.5, y = 0.49)
vpb_ <- viewport(width = 0.35, height = 0.35, x = 0.23, y = 0.7)
vpc_ <- viewport(width = 0.35, height = 0.35, x = 0.82, y = 0.7)
print(a, vp = vpa_)
print(b, vp = vpb_)
print(c, vp = vpc_)
{% endhighlight %}

![center](/public/img/collessall.png) 


### And the same for Gamma stat, which measures the distribution of nodes in time. 

{% highlight r linenos %}
gamma_df <- ldply(trees, foo, metric="gamma") # calculate metric for each tree
gam_percent_low <- round(length(gamma_df[gamma_df$V1 < -1, "V1"])/numtrees, 2)*100
gam_percent_high <- round(length(gamma_df[gamma_df$V1 > 1, "V1"])/numtrees, 2)*100
a <- ggplot(gamma_df, aes(V1)) +  # plot histogram of distribution of values
	geom_histogram() + 
	theme_bw(base_size=18) + 
	scale_x_continuous(breaks=c(-3,-2,-1,0,1,2,3)) + 
	geom_vline(xintercept = -1, colour="red", linetype = "longdash") +
	geom_vline(xintercept = 1, colour="red", linetype = "longdash") +
	ggtitle(paste0("Distribution of Gamma metric for 1000 trees, cutoffs at -1 and 1 results in\n ", gam_percent_low, "% (", numtrees*(gam_percent_low/100), ") trees with deeper nodes (left) and ", gam_percent_high, "% (", numtrees*(gam_percent_high/100), ") trees with shallower nodes (right)")) +  
	labs(x = "Gamma Metric Value", y = "Number of phylogenetic trees") +
	theme(plot.title  = element_text(size = 16))
b <- ggphylo(trees[which.min(gamma_df$V1)], do.plot=F) + theme_myblank()
c <- ggphylo(trees[which.max(gamma_df$V1)], do.plot=F) + theme_myblank()

grid.newpage()
pushViewport(viewport(layout = grid.layout(1,1)))
vpa_ <- viewport(width = 1, height = 1, x = 0.5, y = 0.49)
vpb_ <- viewport(width = 0.35, height = 0.35, x = 0.23, y = 0.7)
vpc_ <- viewport(width = 0.35, height = 0.35, x = 0.82, y = 0.7)
print(a, vp = vpa_)
print(b, vp = vpb_)
print(c, vp = vpc_)
{% endhighlight %}

![center](/public/img/gammaall.png) 


*********
#### Get the .Rmd file used to create this post [at my github account](https://github.com/sckott/sckott.github.com/tree/master/_drafts/2012-10-10-phylogenetic-tree-balance.Rmd) - or [.md file](https://github.com/sckott/sckott.github.com/tree/master/_posts/2012-10-10-phylogenetic-tree-balance.md).

#### Written in [Markdown](http://daringfireball.net/projects/markdown/), with help from [knitr](http://yihui.name/knitr/).

  </div>
  
</div>

<!-- Pagination links -->
<div class="pagination">
  
    <a href="/page30" class="older">Older</a>
  
  
    
      <a href="/page28" class="newer">Newer</a>
    
  
</div>

    </div>

    <!-- for bootstrap tooltips -->
    <script type="text/javascript">
      $("[data-toggle=\"tooltip\"]").tooltip();
    </script>

  </body>

  <footer>
  <!-- Disqus code -->
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'recology'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function () {
          var s = document.createElement('script'); s.async = true;
          s.type = 'text/javascript';
          s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
      }());
  </script>

  <!-- google analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-63197374-1', 'auto');
    ga('send', 'pageview');
  </script>
</footer>

</html>
