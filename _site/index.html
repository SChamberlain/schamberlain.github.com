<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <title>
    
    Recology, R ecology
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Abril+Fatface">


  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/favicon.ico">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.css" rel="stylesheet">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0f layout-reverse">

    <header class="masthead">
      <div class="masthead-inner">
        <h1>Recology</h1>
        <!-- <h1> <a href="http://recology.info/">Recology</a></h1> -->
        <p class="lead">R/etc.</p>

        <div class="colophon">
          <ul class="colophon-links">
            <li>
              <a href="/"><i class="fa fa-home fa-lg"></i></a>&nbsp;
              <a href="/about"><i class="fa fa-info-circle fa-lg"></i></a>&nbsp;
              <a href="/archives"><i class="fa fa-archive fa-lg"></i></a>&nbsp;
              <a href="/rresources"><i class="fa fa-book fa-lg"></i></a>&nbsp;
              <a href="http://rforcats.net/" rel><i class="fa fa-graduation-cap fa-lg"></i></a>&nbsp;
              <a href="http://feeds.feedburner.com/github/wpna"><i class="fa fa-rss fa-lg"></i></a>&nbsp;
              <a href="https://twitter.com/recology_"><i class="fa fa-twitter fa-lg"></i></a>&nbsp;
              <a href="/fork"><i class="fa fa-spinner fa-lg"></i></a>
            </li>
          </ul>
          <!-- <small><a href="https://github.com/mdo/hyde">Hyde</a> from <a href="https://twitter.com/mdo" target="_blank">@mdo</a>.</small> -->
        </div>
      </div>
    </header>

    <div class="content container">
      <div class="posts">
  <a style="float:right;" href="/archives"><i class="fa fa-archive fa-lg"></i></a>
  
  <div class="post">
    <h1>
      <a href="/2014/12/multi-handle/">
        Dealing with multi handle errors
      </a>
    </h1>

    <span class="post-date">08 Dec 2014</span>

    <p>At rOpenSci we occasssionally hear from our users that they run into an error like:</p>

<pre><code class="r">Error in function (type, msg, asError = TRUE)  : 
  easy handled already used in multi handle
</code></pre>

<p>This error occurs in the <code>httr</code> package that we use to do http requests to sources of data on the web. It happens when e.g., you make a lot of requests to a resource, then it gets interrupted somehow - then you make another call, and you get the error above. Let's try it with the an version of <code>httr</code> (<code>v0.5</code>):</p>

<pre><code class="r">library("httr")
# run, then esc to cause multi handle error
replicate(50, GET("http://google.com/"))
# then retry single call, which trows multi handle error
GET("http://google.com/")
#&gt; Error in function (type, msg, asError = TRUE)  : 
#&gt;   easy handled already used in multi handle
</code></pre>

<p>There are any number of reasons why your session may get interrupted, including an internet outage, the web service you are requesesting data from times out, etc.  There hasn't been a straight-forward way to handle this, until recently.</p>

<p>In <code>httr</code> version <code>0.6</code>, there are two new functions <code>handle_find()</code> and <code>handle_reset()</code> to help deal with this error.</p>

<p>First, install newest httr from Github</p>

<pre><code class="r">install.packages("devtools")
devtools::install_github("hadley/httr")
</code></pre>

<pre><code class="r">library("httr")
</code></pre>

<p>Make a bunch of requests to google, interrupting part way through</p>

<pre><code class="r">replicate(50, HEAD("http://google.com/"))
</code></pre>

<p>Then retry single call, which trows multi handle error</p>

<pre><code class="r">HEAD("http://google.com/")
#&gt; Error in function (type, msg, asError = TRUE)  : 
#&gt;   easy handled already used in multi handle
</code></pre>

<p>Find handle</p>

<pre><code class="r">handle_find("http://google.com/")
#&gt; Host: http://google.com/ &lt;0x10f3d1600&gt;
</code></pre>

<p>Reset handle</p>

<pre><code class="r">handle_reset("http://google.com/")
</code></pre>

<p>Try call again, this time it should work</p>

<pre><code class="r">HEAD("http://google.com/")
#&gt; Response [http://www.google.com/]
#&gt;   Date: 2014-12-08 13:37
#&gt;   Status: 200
#&gt;   Content-Type: text/html; charset=ISO-8859-1
#&gt; &lt;EMPTY BODY&gt;
</code></pre>

<h2>Usage in ropensci packages</h2>

<p>We have more work to do yet to integrate this into our packages. It's great you can reset a handle as above, but to reset the handle you need to search for the URL used in the request, which our users would have to dig into the code for the function they are using. That is easy-ish to do, but perhaps not everyone knows they can get to the code easily.  So, we may try seting a parameter in functions that would let reset the handle to clear this error.</p>

<h2>Note</h2>

<p>Note that Hadley is planning on eliminating <code>RCurl</code> dependency (https://github.com/hadley/httr/issues/172), so there may be a different solution in the future.</p>

  </div>
  
  <div class="post">
    <h1>
      <a href="/2014/12/rplos-pubs-country/">
        Publications by author country
      </a>
    </h1>

    <span class="post-date">03 Dec 2014</span>

    <p>I just missed another chat on the rOpenSci website:</p>

<blockquote><p>I want to know the number of publications by people from a certain country, but I dont know how to achieve this...</p></blockquote>

<p>Fun! Let's do that. It's a bit complicated because there is no field like geography of the authors. But there are affiliation fields, from which we can collect data we need.</p>

<h2>Installation</h2>

<p>You'll need the GitHub version for the coutry names data, or just use the CRAN version, and get country names elsewhere.</p>

<pre><code class="r">install.packages("devtools")
devtools::install_github("ropensci/rplos")
</code></pre>

<pre><code class="r">library("rplos")
</code></pre>

<h2>Get the data</h2>

<pre><code class="r">articles &lt;- searchplos(q='*:*', limit = 5,
    fl=c("id","author_affiliate"), 
    fq=list('article_type:"Research Article"', "doc_type:full"))
</code></pre>

<h2>Search for country names in affilitation field</h2>

<pre><code class="r">(countries &lt;- lapply(articles$data$author_affiliate, function(x){
  out &lt;- sapply(isocodes$name, function(z) grepl(z, x))
  isocodes$name[out]
}))
#&gt; [[1]]
#&gt; character(0)
#&gt; 
#&gt; [[2]]
#&gt; [1] "Jersey"        "United States"
#&gt; 
#&gt; [[3]]
#&gt; [1] "China"   "Germany"
#&gt; 
#&gt; [[4]]
#&gt; character(0)
#&gt; 
#&gt; [[5]]
#&gt; [1] "Argentina"      "United Kingdom"
</code></pre>

<p>You can combine this data with the previously collected data:</p>

<pre><code class="r"># Helper function
splitem &lt;- function(x){
  if(length(x) == 0) { NA } else {
    if(length(x) &gt; 1) paste0(x, collapse = ", ") else x
  }
}

articles$data$countries &lt;- sapply(countries, splitem)
head(articles$data)
#&gt;                             id
#&gt; 1 10.1371/journal.pone.0095870
#&gt; 2 10.1371/journal.pone.0110535
#&gt; 3 10.1371/journal.pone.0110991
#&gt; 4 10.1371/journal.pone.0111234
#&gt; 5 10.1371/journal.pone.0111388
#&gt;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                author_affiliate
#&gt; 1 Institute of Epidemiology and Preventive Medicine, College of Public Health, National Taiwan University, Taipei, Taiwan; Department of Clinical Laboratory Sciences and Medical Biotechnology, College of Medicine, National Taiwan University, Taipei, Taiwan; Department of Gastroenterology, Ren-Ai Branch, Taipei City Hospital, Taipei, Taiwan; Division of Gastroenterology, Department of Internal Medicine, National Taiwan University Hospital and National Taiwan University College of Medicine, Taipei, Taiwan; Liver Research Unit, Chang Gung Memorial Hospital, Chang Gung University College of Medicine, Taipei, Taiwan; Division of Gastroenterology, Department of Medicine, Taipei Veterans General Hospital, Taipei, Taiwan; Cheng Hsin General Hospital, Taipei, Taiwan
#&gt; 2    Durham Nephrology Associates, Durham, North Carolina, United States of America; Scientific Activities Department, The National Kidney Foundation, Inc., New York, New York, United States of America; Covance Inc., Princeton, New Jersey, United States of America; Departments of Medicine and Population Health Sciences, University of Wisconsin School of Medicine and Public Health, Madison, Wisconsin, United States of America; Department of Family Medicine, University at Buffalo, Buffalo, New York, United States of America; Baylor Health Care System, Baylor Heart and Vascular Institute, Dallas, Texas, United States of America; Department of Medicine, Division of Nephrology, Icahn School of Medicine at Mount Sinai, New York, New York, United States of America
#&gt; 3                                                                                                                                                                                                                                                                                                                                                                                                                                  State Key Laboratory of Electronic Thin Films and Integrated Devices, School of Microelectronics and Solid-State electronics, University of Electronic Science and Technology of China, Sichuan, China; Electrical and Computer Engineering, Kaiserslautern University of Technology, Kaiserslautern German Gottlieb-Daimler-Strabe, Kaiserslautern, Germany
#&gt; 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         SB RAS Institute of Chemical Biology and Fundamental Medicine, Novosibirsk, Russia; Pacific Institute of Bioorganic Chemistry, Far East Division, Russian Academy of Sciences, Vladivostok, Russia; Novosibirsk State University, Novosibirsk, Russia
#&gt; 5                                                                                                                                                                                                                                                                                                                                                                                   CONICET, Consejo Nacional de Investigaciones Científicas y Técnicas, Ciudad Autónoma de Buenos Aires, Buenos Aires, Argentina; INGEO, Instituto de Geología, Facultad de Ciencias Exactas, Físicas y Naturales, Universidad Nacional de San Juan, San Juan, San Juan, Argentina; School of Geography, Earth and Environmental Sciences, University of Birmingham, Birmingham, West Midlands, United Kingdom
#&gt;                   countries
#&gt; 1                      &lt;NA&gt;
#&gt; 2     Jersey, United States
#&gt; 3            China, Germany
#&gt; 4                      &lt;NA&gt;
#&gt; 5 Argentina, United Kingdom
</code></pre>

<h2>Bigger data set</h2>

<p>Okay, cool, lets do it on a bigger data set, and this time, we'll get another variable <code>counter_total_all</code>, which is the combination of page views/pdf downloads for each article. This will allow us to ask <em>Is number of countries included in the authors related to page views?</em>. I have no idea if this question makes sense, but nonetheless, it is a question :)</p>

<pre><code class="r">articles &lt;- searchplos(q='*:*', limit = 1000,
    fl=c("id","counter_total_all","author_affiliate"), 
    fq=list('article_type:"Research Article"', "doc_type:full"))
#&gt; 1 
#&gt; 2
</code></pre>

<p>Get countries</p>

<pre><code class="r">countries &lt;- lapply(articles$data$author_affiliate, function(x){
  out &lt;- sapply(isocodes$name, function(z) grepl(z, x))
  isocodes$name[out]
})
df &lt;- articles$data
df$countries &lt;- sapply(countries, splitem)
</code></pre>

<p>Let's remove those rows with 0 countries, since the authors must be from somewhere, so the country name matching must have errored.</p>

<pre><code class="r">df$n_countries &lt;- sapply(countries, length)
df &lt;- df[ df$n_countries &gt; 0, ]
</code></pre>

<p>Plot data</p>

<pre><code class="r">library("ggplot2")
ggplot(df, aes(n_countries, as.numeric(counter_total_all))) +
  geom_point() +
  labs(y="total page views") + 
  theme_grey(base_size = 16)
</code></pre>

<p><img src="figure/unnamed-chunk-10-1.png" alt="plot of chunk unnamed-chunk-10" /></p>

<p>Conclusion: meh, maybe, maybe not</p>

<h2>Into rplos</h2>

<p>We'll probably add a function like this into <code>rplos</code>, as a convenient way to handle this use case.</p>

  </div>
  
  <div class="post">
    <h1>
      <a href="/2014/12/http-codes/">
        http codes
      </a>
    </h1>

    <span class="post-date">02 Dec 2014</span>

    <p>Recently noticed a little Python library called <a href="https://github.com/rspivak/httpcode">httpcode</a> that does a simple thing: gives information on http codes in the CLI. I thought this could maybe potentially be useful for R. So I made an R version.</p>

<h2>Installation</h2>

<pre><code class="r">devtools::install_github("sckott/httpcode")
</code></pre>

<pre><code class="r">library("httpcode")
</code></pre>

<h2>Search by http code</h2>

<pre><code class="r">http_code(100)
#&gt; &lt;Status code: 100&gt;
#&gt;   Message: Continue
#&gt;   Explanation: Request received, please continue
</code></pre>

<pre><code class="r">http_code(400)
#&gt; &lt;Status code: 400&gt;
#&gt;   Message: Bad Request
#&gt;   Explanation: Bad request syntax or unsupported method
</code></pre>

<pre><code class="r">http_code(503)
#&gt; &lt;Status code: 503&gt;
#&gt;   Message: Service Unavailable
#&gt;   Explanation: The server cannot process the request due to a high load
</code></pre>

<pre><code class="r">http_code(999)
#&gt; Error: No description found for code: 999
</code></pre>

<h2>Fuzzy code search</h2>

<pre><code class="r">http_code('1xx')
#&gt; [[1]]
#&gt; &lt;Status code: 100&gt;
#&gt;   Message: Continue
#&gt;   Explanation: Request received, please continue
#&gt; 
#&gt; [[2]]
#&gt; &lt;Status code: 101&gt;
#&gt;   Message: Switching Protocols
#&gt;   Explanation: Switching to new protocol; obey Upgrade header
#&gt; 
#&gt; [[3]]
#&gt; &lt;Status code: 102&gt;
#&gt;   Message: Processing
#&gt;   Explanation: WebDAV; RFC 2518
</code></pre>

<pre><code class="r">http_code('3xx')
#&gt; [[1]]
#&gt; &lt;Status code: 300&gt;
#&gt;   Message: Multiple Choices
#&gt;   Explanation: Object has several resources -- see URI list
#&gt; 
#&gt; [[2]]
#&gt; &lt;Status code: 301&gt;
#&gt;   Message: Moved Permanently
#&gt;   Explanation: Object moved permanently -- see URI list
#&gt; 
#&gt; [[3]]
#&gt; &lt;Status code: 302&gt;
#&gt;   Message: Found
#&gt;   Explanation: Object moved temporarily -- see URI list
#&gt; 
#&gt; [[4]]
#&gt; &lt;Status code: 303&gt;
#&gt;   Message: See Other
#&gt;   Explanation: Object moved -- see Method and URL list
#&gt; 
#&gt; [[5]]
#&gt; &lt;Status code: 304&gt;
#&gt;   Message: Not Modified
#&gt;   Explanation: Document has not changed since given time
#&gt; 
#&gt; [[6]]
#&gt; &lt;Status code: 305&gt;
#&gt;   Message: Use Proxy
#&gt;   Explanation: You must use proxy specified in Location to access this resource.
#&gt; 
#&gt; [[7]]
#&gt; &lt;Status code: 306&gt;
#&gt;   Message: Switch Proxy
#&gt;   Explanation: Subsequent requests should use the specified proxy
#&gt; 
#&gt; [[8]]
#&gt; &lt;Status code: 307&gt;
#&gt;   Message: Temporary Redirect
#&gt;   Explanation: Object moved temporarily -- see URI list
#&gt; 
#&gt; [[9]]
#&gt; &lt;Status code: 308&gt;
#&gt;   Message: Permanent Redirect
#&gt;   Explanation: Object moved permanently
</code></pre>

<pre><code class="r">http_code('30[12]')
#&gt; [[1]]
#&gt; &lt;Status code: 301&gt;
#&gt;   Message: Moved Permanently
#&gt;   Explanation: Object moved permanently -- see URI list
#&gt; 
#&gt; [[2]]
#&gt; &lt;Status code: 302&gt;
#&gt;   Message: Found
#&gt;   Explanation: Object moved temporarily -- see URI list
</code></pre>

<pre><code class="r">http_code('30[34]')
#&gt; [[1]]
#&gt; &lt;Status code: 303&gt;
#&gt;   Message: See Other
#&gt;   Explanation: Object moved -- see Method and URL list
#&gt; 
#&gt; [[2]]
#&gt; &lt;Status code: 304&gt;
#&gt;   Message: Not Modified
#&gt;   Explanation: Document has not changed since given time
</code></pre>

<h2>Search by text message</h2>

<pre><code class="r">http_search("request")
#&gt; [[1]]
#&gt; &lt;Status code: 100&gt;
#&gt;   Message: Continue
#&gt;   Explanation: Request received, please continue
#&gt; 
#&gt; [[2]]
#&gt; &lt;Status code: 200&gt;
#&gt;   Message: OK
#&gt;   Explanation: Request fulfilled, document follows
#&gt; 
#&gt; [[3]]
#&gt; &lt;Status code: 202&gt;
#&gt;   Message: Accepted
#&gt;   Explanation: Request accepted, processing continues off-line
#&gt; 
#&gt; [[4]]
#&gt; &lt;Status code: 203&gt;
#&gt;   Message: Non-Authoritative Information
#&gt;   Explanation: Request fulfilled from cache
#&gt; 
#&gt; [[5]]
#&gt; &lt;Status code: 204&gt;
#&gt;   Message: No Content
#&gt;   Explanation: Request fulfilled, nothing follows
#&gt; 
#&gt; [[6]]
#&gt; &lt;Status code: 306&gt;
#&gt;   Message: Switch Proxy
#&gt;   Explanation: Subsequent requests should use the specified proxy
#&gt; 
#&gt; [[7]]
#&gt; &lt;Status code: 400&gt;
#&gt;   Message: Bad Request
#&gt;   Explanation: Bad request syntax or unsupported method
#&gt; 
#&gt; [[8]]
#&gt; &lt;Status code: 403&gt;
#&gt;   Message: Forbidden
#&gt;   Explanation: Request forbidden -- authorization will not help
#&gt; 
#&gt; [[9]]
#&gt; &lt;Status code: 408&gt;
#&gt;   Message: Request Timeout
#&gt;   Explanation: Request timed out; try again later.
#&gt; 
#&gt; [[10]]
#&gt; &lt;Status code: 409&gt;
#&gt;   Message: Conflict
#&gt;   Explanation: Request conflict.
#&gt; 
#&gt; [[11]]
#&gt; &lt;Status code: 413&gt;
#&gt;   Message: Request Entity Too Large
#&gt;   Explanation: Entity is too large.
#&gt; 
#&gt; [[12]]
#&gt; &lt;Status code: 414&gt;
#&gt;   Message: Request-URI Too Long
#&gt;   Explanation: URI is too long.
#&gt; 
#&gt; [[13]]
#&gt; &lt;Status code: 416&gt;
#&gt;   Message: Requested Range Not Satisfiable
#&gt;   Explanation: Cannot satisfy request range.
#&gt; 
#&gt; [[14]]
#&gt; &lt;Status code: 503&gt;
#&gt;   Message: Service Unavailable
#&gt;   Explanation: The server cannot process the request due to a high load
#&gt; 
#&gt; [[15]]
#&gt; &lt;Status code: 505&gt;
#&gt;   Message: HTTP Version Not Supported
#&gt;   Explanation: Cannot fulfill request.
</code></pre>

<pre><code class="r">http_search("forbidden")
#&gt; [[1]]
#&gt; &lt;Status code: 403&gt;
#&gt;   Message: Forbidden
#&gt;   Explanation: Request forbidden -- authorization will not help
</code></pre>

<pre><code class="r">http_search("too")
#&gt; [[1]]
#&gt; &lt;Status code: 413&gt;
#&gt;   Message: Request Entity Too Large
#&gt;   Explanation: Entity is too large.
#&gt; 
#&gt; [[2]]
#&gt; &lt;Status code: 414&gt;
#&gt;   Message: Request-URI Too Long
#&gt;   Explanation: URI is too long.
</code></pre>

<pre><code class="r">http_search("birds")
#&gt; Error: No status code found for search: : birds
</code></pre>

  </div>
  
</div>

<!-- Pagination links -->
<div class="pagination">
  
    <a href="/page2" class="older">Older</a>
  
  
    <span class="previous">Newer</span>
  
</div>

    </div>

  </body>

  <footer>  
  <!-- Disqus code -->
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'recology'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function () {
          var s = document.createElement('script'); s.async = true;
          s.type = 'text/javascript';
          s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
      }());
  </script>

  <!-- Gaug.es Analytics -->
  <script type="text/javascript">
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '4efd83a6f5a1f5158a000004');
      t.src = '//secure.gaug.es/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  </script>
</footer>
</html>
