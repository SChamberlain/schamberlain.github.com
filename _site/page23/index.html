<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <title>
    
    Recology, R/etc.
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Abril+Fatface">

  <link rel="stylesheet" href="/public/css/bootstrap/css/bootstrap.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/favicon.ico">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0f layout-reverse">

    <header class="masthead">
      <div class="masthead-inner">
        <h1>Recology</h1>
        <!-- <h1> <a href="http://recology.info/">Recology</a></h1> -->
        <p class="lead">R/etc.</p>

        <div class="colophon">
          <ul class="colophon-links">
            <li>
              <a href="/"><i class="fa fa-home fa-lg"></i></a>&nbsp;
              <a href="/about"><i class="fa fa-info-circle fa-lg"></i></a>&nbsp;
              <a href="/archives"><i class="fa fa-archive fa-lg"></i></a>&nbsp;
              <a href="/rresources"><i class="fa fa-book fa-lg"></i></a>&nbsp;
              <a href="http://rforcats.net/" rel><i class="fa fa-graduation-cap fa-lg"></i></a>&nbsp;
              <a href="/feed.xml"><i class="fa fa-rss fa-lg"></i></a>&nbsp;
              <a href="https://twitter.com/sckottie"><i class="fa fa-twitter fa-lg"></i></a>&nbsp;
              <a href="/fork"><i class="fa fa-spinner fa-lg"></i></a>
            </li>
          </ul>
          <!-- <small><a href="https://github.com/mdo/hyde">Hyde</a> from <a href="https://twitter.com/mdo" target="_blank">@mdo</a>.</small> -->
        </div>
      </div>
    </header>

    <div class="content container">
      <div class="posts">
  <a style="float:right;" href="/archives" data-toggle="tooltip" data-placement="bottom" title="Archives"><i class="fa fa-archive fa-lg"></i></a>
  <a style="float:right;" href="/tags"><i class="fa fa-tags fa-lg"></i></a>&nbsp;
  
  <div class="post">
    <h1>
      <a href="/2013/06/geojson/">
        R to GeoJSON
      </a>
    </h1>

    <span class="post-date">30 Jun 2013</span>

    **UPDATE** As you can see in Patrick's comment below you can convert to GeoJSON format files with rgdal as an alternative to calling the Ogre web API described below. See [here](https://github.com/patperu/write2geojson/blob/master/write-geojson.R) for example code for converting to GeoJSON with rgdal.

***************

GitHub recently introduced the ability to render [GeoJSON][geojson] files on their site as maps [here][post1], and recently introduced [here][post2] support for [TopoJSON][topojson], an extension of GeoJSON can be up to 80% smaller than GeoJSON, support for other file extensions (`.topojson` and `.json`), and you can embed the maps on other sites (so awesome). The underlying maps used on GitHub are [Openstreet Maps][openstreet]. 

A recent blog post showed how to convert .shp or .kml files to GeoJSON to then upload to GitHub [here][ruby]. The approach used Ruby on the command line locally to convert the geospatial files to GeoJSON. 

Can we do this in R? Perhaps others have already done this, but there's more than one way to do anything, no? 

I'm not aware of a converter to GeoJSON within R, but there is a web service that can do this, called [Ogre][ogre]. The service lets you `POST` a file, which then converts to GeoJSON and gives it back to you. Ogre accepts many different file formats: BNA, CSV, DGN, DXF, zipped shapefiles, GeoConcept, GeoJSON, GeoRSS, GML, GMT, KML, MapInfo, and VRT. 

We can use the Ogre API to upload a local geospatial file of various formats and get the GeoJSON back, then put it up on GitHub, and they render the map for you. Sweetness. 

So here's the protocol. 

***************

### 1. Load httr. What is httr? For those not in the know it is a simpler wrapper around RCurl, a curl interface for R.


{% highlight r %}
# install.packages('httr')
library(httr)
{% endhighlight %}

### 2. Here is a function to convert your geospatial files to GeoJSON (with roxygen docs).


{% highlight r %}
togeojson <- function(file, writepath = "~") {
    url <- "http://ogre.adc4gis.com/convert"
    tt <- POST(url, body = list(upload = upload_file(file)))
    out <- content(tt, as = "text")
    fileConn <- file(writepath)
    writeLines(out, fileConn)
    close(fileConn)
}
{% endhighlight %}

### 3. Convert a file to GeoJSON

**KML**

In the first line I specify the location of the file on my machine. In the second line the function `togeojson` reads in the file, sends the file to the API endpoint *http://ogre.adc4gis.com/convert*, collects the returned GeoJSON object, and saves the GeoJSON to a file that you specify. Here we are converting a KML file with point occurrences (data collected from [USGS's BISON service](http://bison.usgs.ornl.gov/)). 


{% highlight r %}
file <- "~/github/sac/rgeojson/acer_spicatum.kml"
togeojson(file, "~/github/sac/rgeojson/acer_spicatum.geojson")
{% endhighlight %}


**Shapefiles**

Here, we are converting a zip file containing shape files for *Pinus contorta* (data collected from the USGS [here](http://esp.cr.usgs.gov/data/little/). 


{% highlight r %}
file <- "~/github/sac/rgeojson/pinucont.zip"
togeojson(file, "~/github/sac/rgeojson/pinus.geojson")
{% endhighlight %}


### 4. Then commit and push to GitHub. And this is what they look like on GitHub

*Acer spicatum* distribution (points)

<!-- ![](/public/img/acer_spiacdtum_dist.png) -->
<script src="https://embed.github.com/view/geojson/sckott/rgeojson/output/acer_spicatum.geojson"></script>

*Pinus contorta* distribution (polygons)

<!-- ![](/public/img/pinus_dist.png) -->
<script src="https://embed.github.com/view/geojson/sckott/rgeojson/output/pinus.geojson"></script>

***************

If you want, you can clone a repo from my account. Then do the below. (of course, you must have git installed, and have a GitHub account...)

First, fork my `rgeojson` repo [here](https://github.com/sckott/rgeojson) to your GitHub account.

Second, in your terminal/command line...

{% highlight bash %}
git clone https://github.com/<yourgithubusername>/rgeojson.git
cd rgeojson
{% endhighlight %}

Third, in R specify the location of either the KML file or the zipped shape files, then call `togeojson` function to convert the KML file to a GeoJSON file (which should output a file *acer_spicatum.geojson*)


{% highlight r %}
file <- "/path/to/acer_spicatum.kml"
togeojson(file, "~/path/to/write/to/acer_spicatum.geojson")
{% endhighlight %}


Fourth, back in the terminal...

{% highlight bash %}
git add acer_spicatum.geojson
git commit -a -m 'some cool commit message'
git push
{% endhighlight %}

Fifth, go to your *rgeojson* repo on GitHub and click on the *acer_spicatum.geojson* file, and the map should render.

***************

Look for this functionality to come to the [rbison][rbison] and [rgbif][rgbif] R packages soon. Why is that cool?  Think of the workflow: Query for species occurrence data in the BISON or GBIF databases, convert the results to a GeoJSON file, push to GitHub, and you have an awesome interactive map on the web. Not too bad eh. 

[post1]: https://github.com/blog/1528-there-s-a-map-for-that
[post2]: https://github.com/blog/1541-geojson-rendering-improvements
[openstreet]: http://www.openstreetmap.org/
[ruby]: http://ben.balter.com/2013/06/26/how-to-convert-shapefiles-to-geojson-for-use-on-github/
[geojson]: http://en.wikipedia.org/wiki/GeoJSON
[topojson]: https://github.com/mbostock/topojson
[ogre]: http://ogre.adc4gis.com/
[rbison]: https://github.com/ropensci/rbison
[rgbif]: https://github.com/ropensci/rgbif

  </div>
  
  <div class="post">
    <h1>
      <a href="/2013/06/sofa/">
        Put some cushions on the sofa
      </a>
    </h1>

    <span class="post-date">21 Jun 2013</span>

    I posted earlier this week about sofa ([here][blog]), introducing a package I started recently that interacts with CouchDB from R. There's been a fair amount of response at least in terms of page views, so I'll take that as a sign to keep going. 

One thing that would be nice while you are CouchDB-ing is to interact with local *and* remote databases. I have incorporated the ability to interact with remote CouchDB databases in many of the functions, not all though. The remote data stores supported right now are Cloudant and Iriscouch. 

Hadley Wickham suggested that a package called `sofa` should have something called `cushion`. And so it must be. It's just a small function, called `cushion`, which puts a cushion on the sofa, or in reality, sets up your authentication for remote data stores. `cushion` just writes your username and password to your options list and then the functions look for your authentication details via `getOption`. Of course these auth details aren't stored permanently - when you restart R you have to write them again to options. You can store them permanently in your `.Rprofile` file if you like, usally at ~/.Rprofile by putting in entry like options(cloudant.pwd = "mycoolpassword").

***************

### Load sofa

{% highlight r %}
# install.packages('devtools'); library(devtools); install_github('sofa', 'sckott')
library(sofa)
{% endhighlight %}


***************

### Put a cushion on the sofa - that is, save your auth details


{% highlight r %}
cushion(iriscouch_name = "yourusername", iriscouch_pwd = "yourpwd", 
    cloudant_name = "yourusername", cloudant_pwd = "yourpwd")
{% endhighlight %}


***************

### Ping each server

{% highlight r %}
sofa_ping()
{% endhighlight %}



{% highlight text %}
$couchdb
[1] "Welcome"

$version
[1] "1.2.1"
{% endhighlight %}



{% highlight r %}
sofa_ping("iriscouch")
{% endhighlight %}



{% highlight text %}
$couchdb
[1] "Welcome"

$uuid
[1] "f1cb5d2e881bcb529d2eb2d04f548683"

$version
[1] "1.3.0"

$vendor
$vendor$version
[1] "1.3.0r1"

$vendor$name
[1] "Iris Couch"
{% endhighlight %}



{% highlight r %}
sofa_ping("cloudant")
{% endhighlight %}



{% highlight text %}
$couchdb
[1] "Welcome"

$version
[1] "1.0.2"

$cloudant_build
[1] "1323"
{% endhighlight %}


***************

Now we'll do similar tasks on a local and two remote databases (cloudant and iriscouch)

### Create a database

{% highlight r %}
sofa_createdb(dbname = "hello_world")  # local
{% endhighlight %}



{% highlight text %}
  ok 
TRUE 
{% endhighlight %}



{% highlight r %}
sofa_createdb(dbname = "hello_world", "iriscouch")  # iriscouch
{% endhighlight %}



{% highlight text %}
  ok 
TRUE 
{% endhighlight %}



{% highlight r %}
sofa_createdb(dbname = "hello_world", "cloudant")  # cloudant
{% endhighlight %}



{% highlight text %}
  ok 
TRUE 
{% endhighlight %}


***************

Listing your databases is a simple task

### List your databases

{% highlight r %}
sofa_listdbs()  # local
{% endhighlight %}



{% highlight text %}
 [1] "_replicator"                "_users"                    
 [3] "alm_couchdb"                "alm_db"                    
 [5] "cheese"                     "dudedb"                    
 [7] "example"                    "foobar"                    
 [9] "foodb"                      "hello_world"               
[11] "helloworld"                 "rplos_db"                  
[13] "shit"                       "shitty"                    
[15] "shitty2"                    "sofadb"                    
[17] "test_suite_db"              "test_suite_db/with_slashes"
[19] "test_suite_reports"         "testr2couch"               
[21] "twitter_db"                
{% endhighlight %}



{% highlight r %}
sofa_listdbs("iriscouch")  # iriscouch
{% endhighlight %}



{% highlight text %}
[1] "_replicator" "_users"      "foobar"      "hello_world" "helloworld" 
[6] "mustache"    "stuff"       "thing"      
{% endhighlight %}



{% highlight r %}
sofa_listdbs("cloudant")  # cloudant
{% endhighlight %}



{% highlight text %}
[1] "dudedb"         "foobar"         "hello_world"    "helloworld"    
[5] "mustache"       "thingsandstuff"
{% endhighlight %}


***************

### Write a document to a database

{% highlight r %}
doc <- "{\"name\":\"dude\",\"icecream\":\"rocky road\"}"
sofa_writedoc(dbname = "helloworld", doc = doc)  # local
{% endhighlight %}



{% highlight text %}
$ok
[1] TRUE

$id
[1] "da2b0d1eb457dc764a6283fa59001606"

$rev
[1] "1-5406480672da172726810767e7d0ead3"
{% endhighlight %}



{% highlight r %}
sofa_writedoc("iriscouch", dbname = "helloworld", doc = doc)  # iriscouch
{% endhighlight %}



{% highlight text %}
$ok
[1] TRUE

$id
[1] "0c0858b75a81c464a74119ca2400135d"

$rev
[1] "1-5406480672da172726810767e7d0ead3"
{% endhighlight %}



{% highlight r %}
sofa_writedoc("cloudant", dbname = "helloworld", doc = doc)  # cloudant
{% endhighlight %}



{% highlight text %}
$ok
[1] TRUE

$id
[1] "b77808eae8ae8d79ae78a373bf5b02d1"

$rev
[1] "1-5406480672da172726810767e7d0ead3"
{% endhighlight %}

***************

There's lots more you can do of course...

Thoughts? Feelings? Criticism?

[blog]: http://sckott.github.io/2013/06/couch/

  </div>
  
  <div class="post">
    <h1>
      <a href="/2013/06/coffeehouse/">
        Coffeehouse - an aggregator for blog posts about data, data management, etc.
      </a>
    </h1>

    <span class="post-date">18 Jun 2013</span>

    Have you heard of [DataONE](http://www.dataone.org/)? It stands for the Data Observation Network for Earth, and I am involved in the [Community Education and Engagement working group](http://www.dataone.org/working_groups/community-education-and-engagement) at DataONE. We try to communicate about data, data management, and similar things to scientists and other DataONE *stakeholders*. 

At our last meeting, we decided to start a blog aggregator to pull in to one place blog posts about data, data management, and related topics. Those reading this blog have likely heard of [R-Bloggers](http://www.r-bloggers.com/) - and there are many more aggregator blogs. We are calling this blog aggregator **Coffeehouse** - as it's sort of a place to gather to talk/read about ideas. Check it out [here][coffee]. If you blog about data management think about adding your blog to Coffeehouse - go to the [*Add your blog*][addblog] page to do so. A screenshot:

![](/public/img/coffeehouse.png)

********************

The blogs already added to Coffeehouse:

<i class="icon-coffee"></i> <a href="http://dataconservancy.org/blog/" target="_blank">Data Conservancy</a><br>
<i class="icon-coffee"></i> <a href="http://datapub.cdlib.org/" target="_blank">Data Pub</a><br>
<i class="icon-coffee"></i> <a href="http://www.datacite.org/" target="_blank">DataCite</a><br>
<i class="icon-coffee"></i> <a href="http://researchremix.wordpress.com/" target="_blank">Research Remix</a><br>
<i class="icon-coffee"></i> <a href="http://blogs.loc.gov/digitalpreservation/" target="_blank">The Signal: Digital Preservation</a>

********************

The tech/styling details:

+ As is obvious we are using Wordpress.org, with the Magazine Basic theme.
+ We don't accept comments - when someone clicks on the comments button it sends them back to the original post. This is on purpose so that the authors of the post get the comments on their own site.
+ On the top of each post there is an alert to tell you the post is syndicated, and gives a link to the original post. You can close this alert if it's annoying to you.
+ Style - we have strived to use clean and simple styling to make for a nice reading experience. A cluttered website makes reading painful. And using the [Twitter Bootstrap WP plugin][boot]
+ Icons: done using the [FontAwesome Wordpress Plugin][fawp].
+ Aggregating posts is done using the [FeedWordPress plugin][fwp].
+ The add your blog form: using the [Nina forms plugin][ninja]
+ Analytics: using the [Gauges WP plugin][gauges]

That's it. Let us know if you have any thoughts/comments.

[coffee]: https://coffeehouse.dataone.org/
[fawp]: https://github.com/rachelbaker/Font-Awesome-WordPress-Plugin
[addblog]: https://coffeehouse.dataone.org/add-your-blog/
[fwp]: http://feedwordpress.radgeek.com/
[ninja]: http://wpninjas.com/ninja-forms/
[boot]: http://www.icontrolwp.com/our-wordpress-plugins/wordpress-twitter-bootstrap-css-plugin-home/
[gauges]: http://wordpress.org/plugins/gauges/

  </div>
  
</div>

<!-- Pagination links -->
<div class="pagination">
  
    <a href="/page24" class="older">Older</a>
  
  
    
      <a href="/page22" class="newer">Newer</a>
    
  
</div>

    </div>

    <!-- for bootstrap tooltips -->
    <script type="text/javascript">
      $("[data-toggle=\"tooltip\"]").tooltip();
    </script>

  </body>

  <footer>
  <!-- Disqus code -->
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'recology'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function () {
          var s = document.createElement('script'); s.async = true;
          s.type = 'text/javascript';
          s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
      }());
  </script>

  <!-- google analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-63197374-1', 'auto');
    ga('send', 'pageview');
  </script>
</footer>

</html>
