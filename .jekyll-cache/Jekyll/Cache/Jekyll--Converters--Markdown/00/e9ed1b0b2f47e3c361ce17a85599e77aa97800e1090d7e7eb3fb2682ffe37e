I"ñT<p>A missed chat on the rOpenSci website the other day asked:</p>

<blockquote>
  <p>Hi there, i am trying to use the taxize package and have a .csv file of species names to run through taxize updating them. What would be the code i would need to run to achieve this?</p>
</blockquote>

<p>One way to answer this is to talk about the basic approach to importing data, doing stuff to the data, then recombining data. There are many ways to do this, but Iâ€™ll go over a few of them.</p>

<h2 id="install-taxize">Install taxize</h2>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">install.packages</span><span class="p">(</span><span class="s2">"taxize"</span><span class="p">)</span><span class="w">
</span><span class="n">install.packages</span><span class="p">(</span><span class="s2">"downloader"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="s2">"taxize"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="import-data">Import data</h2>

<p>Weâ€™ll use Winston Changâ€™s new <code class="highlighter-rouge">downloader</code> package to avoid problems with <code class="highlighter-rouge">https</code>, and get a dataset from our ropensci datasets repo <a href="https://github.com/ropensci/datasets">https://github.com/ropensci/datasets</a></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">downloader</span><span class="o">::</span><span class="n">download</span><span class="p">(</span><span class="s2">"https://raw.githubusercontent.com/ropensci/datasets/master/planttraits/morphological.csv"</span><span class="p">,</span><span class="w"> </span><span class="s2">"morphological.csv"</span><span class="p">)</span><span class="w">
</span><span class="n">dat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"morphological.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span><span class="w">
</span><span class="c1">#&gt;                  species log_SLA leaf_water_content log_wood_density</span><span class="w">
</span><span class="c1">#&gt; 1         Abies concolor    3.46               0.51            -0.52</span><span class="w">
</span><span class="c1">#&gt; 2          Abies grandis    3.58               0.49            -0.51</span><span class="w">
</span><span class="c1">#&gt; 3        Abies magnifica    3.87               0.62            -0.53</span><span class="w">
</span><span class="c1">#&gt; 4      Acacia farnesiana      NA                 NA               NA</span><span class="w">
</span><span class="c1">#&gt; 5           Acer glabrum    5.07               0.69            -0.54</span><span class="w">
</span><span class="c1">#&gt; 6 Adenostoma fasciculata    3.56               0.46            -0.31</span><span class="w">
</span><span class="c1">#&gt;   log_ht log_N</span><span class="w">
</span><span class="c1">#&gt; 1   7.72  0.02</span><span class="w">
</span><span class="c1">#&gt; 2   7.51 -0.31</span><span class="w">
</span><span class="c1">#&gt; 3   7.58 -0.14</span><span class="w">
</span><span class="c1">#&gt; 4   5.70    NA</span><span class="w">
</span><span class="c1">#&gt; 5   3.25  1.02</span><span class="w">
</span><span class="c1">#&gt; 6   5.33  0.29</span><span class="w">
</span></code></pre></div></div>

<p>After importing data, there are a variety of approaches you could take:</p>

<ol>
  <li>Vector: Take species names as vector from your <code class="highlighter-rouge">data.frame</code>, cleaning them, then re-attching to the <code class="highlighter-rouge">data.frame</code> later, or</li>
  <li>In-Place: Use for loops or <code class="highlighter-rouge">lapply</code> family functions to iterate over each name while simultaneously re-inserting into the <code class="highlighter-rouge">data.frame</code></li>
</ol>

<h2 id="1-vector">1. Vector</h2>

<p>Make a vector of names</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">splist</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dat</span><span class="o">$</span><span class="n">species</span><span class="w">
</span></code></pre></div></div>

<p>Then proceed to do name cleaning, e.g, we can use the <code class="highlighter-rouge">tnrs</code> function to see if any names are potentially not spelled correctly.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tnrs_out</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tnrs</span><span class="p">(</span><span class="n">splist</span><span class="p">,</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"iPlant_TNRS"</span><span class="p">)</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">tnrs_out</span><span class="p">)</span><span class="w">
</span><span class="c1">#&gt;              submittedname             acceptedname    sourceid score</span><span class="w">
</span><span class="c1">#&gt; 1     Ceanothus prostratus     Ceanothus prostratus iPlant_TNRS     1</span><span class="w">
</span><span class="c1">#&gt; 2          Abies magnifica          Abies magnifica iPlant_TNRS     1</span><span class="w">
</span><span class="c1">#&gt; 3 Arctostaphylos canescens Arctostaphylos canescens iPlant_TNRS     1</span><span class="w">
</span><span class="c1">#&gt; 4         Berberis nervosa         Berberis nervosa iPlant_TNRS     1</span><span class="w">
</span><span class="c1">#&gt; 5        Arbutus menziesii        Arbutus menziesii iPlant_TNRS     1</span><span class="w">
</span><span class="c1">#&gt; 6     Calocedrus decurrens     Calocedrus decurrens iPlant_TNRS     1</span><span class="w">
</span><span class="c1">#&gt;                matchedname      authority</span><span class="w">
</span><span class="c1">#&gt; 1     Ceanothus prostratus         Benth.</span><span class="w">
</span><span class="c1">#&gt; 2          Abies magnifica  A. Murray bis</span><span class="w">
</span><span class="c1">#&gt; 3 Arctostaphylos canescens         Eastw.</span><span class="w">
</span><span class="c1">#&gt; 4         Berberis nervosa          Pursh</span><span class="w">
</span><span class="c1">#&gt; 5        Arbutus menziesii          Pursh</span><span class="w">
</span><span class="c1">#&gt; 6     Calocedrus decurrens (Torr.) Florin</span><span class="w">
</span><span class="c1">#&gt;                                     uri</span><span class="w">
</span><span class="c1">#&gt; 1 http://www.tropicos.org/Name/27500276</span><span class="w">
</span><span class="c1">#&gt; 2 http://www.tropicos.org/Name/24900142</span><span class="w">
</span><span class="c1">#&gt; 3 http://www.tropicos.org/Name/12302547</span><span class="w">
</span><span class="c1">#&gt; 4  http://www.tropicos.org/Name/3500175</span><span class="w">
</span><span class="c1">#&gt; 5 http://www.tropicos.org/Name/12302436</span><span class="w">
</span><span class="c1">#&gt; 6  http://www.tropicos.org/Name/9400069</span><span class="w">
</span></code></pre></div></div>

<p>Those with score of less than 1 may have misspellings</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tnrs_out</span><span class="p">[</span><span class="w"> </span><span class="n">tnrs_out</span><span class="o">$</span><span class="n">score</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="c1">#&gt;                 submittedname              acceptedname    sourceid score</span><span class="w">
</span><span class="c1">#&gt; 23     Adenostoma fasciculata   Adenostoma fasciculatum iPlant_TNRS  0.97</span><span class="w">
</span><span class="c1">#&gt; 24 Arctostaphylos glandulosus Arctostaphylos glandulosa iPlant_TNRS  0.97</span><span class="w">
</span><span class="c1">#&gt; 36        Chamaebatia foliosa     Chamaebatia foliolosa iPlant_TNRS  0.95</span><span class="w">
</span><span class="c1">#&gt; 38     Juniperus californicus     Juniperus californica iPlant_TNRS  0.97</span><span class="w">
</span><span class="c1">#&gt; 77         Prunus illicifolia         Prunus ilicifolia iPlant_TNRS  0.99</span><span class="w">
</span><span class="c1">#&gt; 78         Prunus subcordatus         Prunus subcordata iPlant_TNRS  0.97</span><span class="w">
</span><span class="c1">#&gt;                  matchedname                         authority</span><span class="w">
</span><span class="c1">#&gt; 23   Adenostoma fasciculatum                      Hook. &amp; Arn.</span><span class="w">
</span><span class="c1">#&gt; 24 Arctostaphylos glandulosa                            Eastw.</span><span class="w">
</span><span class="c1">#&gt; 36     Chamaebatia foliolosa                            Benth.</span><span class="w">
</span><span class="c1">#&gt; 38     Juniperus californica                          CarriÃ¨re</span><span class="w">
</span><span class="c1">#&gt; 77         Prunus ilicifolia (Nutt. ex Hook. &amp; Arn.) D. Dietr.</span><span class="w">
</span><span class="c1">#&gt; 78         Prunus subcordata                            Benth.</span><span class="w">
</span><span class="c1">#&gt;                                      uri</span><span class="w">
</span><span class="c1">#&gt; 23 http://www.tropicos.org/Name/27801458</span><span class="w">
</span><span class="c1">#&gt; 24 http://www.tropicos.org/Name/12300542</span><span class="w">
</span><span class="c1">#&gt; 36 http://www.tropicos.org/Name/27801486</span><span class="w">
</span><span class="c1">#&gt; 38  http://www.tropicos.org/Name/9400374</span><span class="w">
</span><span class="c1">#&gt; 77 http://www.tropicos.org/Name/27801102</span><span class="w">
</span><span class="c1">#&gt; 78 http://www.tropicos.org/Name/27801124</span><span class="w">
</span></code></pre></div></div>

<p>So letâ€™s take the <code class="highlighter-rouge">acceptedname</code> column as a the new names and assign to a new vector</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cleaned_names</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tnrs_out</span><span class="o">$</span><span class="n">acceptedname</span><span class="w">
</span></code></pre></div></div>

<p>Then join names back, replacing them, or adding as a new column</p>

<p>Replace</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dat</span><span class="o">$</span><span class="n">species</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cleaned_names</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span><span class="w">
</span><span class="c1">#&gt;                    species log_SLA leaf_water_content log_wood_density</span><span class="w">
</span><span class="c1">#&gt; 1     Ceanothus prostratus    3.46               0.51            -0.52</span><span class="w">
</span><span class="c1">#&gt; 2          Abies magnifica    3.58               0.49            -0.51</span><span class="w">
</span><span class="c1">#&gt; 3 Arctostaphylos canescens    3.87               0.62            -0.53</span><span class="w">
</span><span class="c1">#&gt; 4         Berberis nervosa      NA                 NA               NA</span><span class="w">
</span><span class="c1">#&gt; 5        Arbutus menziesii    5.07               0.69            -0.54</span><span class="w">
</span><span class="c1">#&gt; 6     Calocedrus decurrens    3.56               0.46            -0.31</span><span class="w">
</span><span class="c1">#&gt;   log_ht log_N</span><span class="w">
</span><span class="c1">#&gt; 1   7.72  0.02</span><span class="w">
</span><span class="c1">#&gt; 2   7.51 -0.31</span><span class="w">
</span><span class="c1">#&gt; 3   7.58 -0.14</span><span class="w">
</span><span class="c1">#&gt; 4   5.70    NA</span><span class="w">
</span><span class="c1">#&gt; 5   3.25  1.02</span><span class="w">
</span><span class="c1">#&gt; 6   5.33  0.29</span><span class="w">
</span></code></pre></div></div>

<p>New column</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dat</span><span class="o">$</span><span class="n">species_cleaned</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cleaned_names</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span><span class="w">
</span><span class="c1">#&gt;                    species log_SLA leaf_water_content log_wood_density</span><span class="w">
</span><span class="c1">#&gt; 1     Ceanothus prostratus    3.46               0.51            -0.52</span><span class="w">
</span><span class="c1">#&gt; 2          Abies magnifica    3.58               0.49            -0.51</span><span class="w">
</span><span class="c1">#&gt; 3 Arctostaphylos canescens    3.87               0.62            -0.53</span><span class="w">
</span><span class="c1">#&gt; 4         Berberis nervosa      NA                 NA               NA</span><span class="w">
</span><span class="c1">#&gt; 5        Arbutus menziesii    5.07               0.69            -0.54</span><span class="w">
</span><span class="c1">#&gt; 6     Calocedrus decurrens    3.56               0.46            -0.31</span><span class="w">
</span><span class="c1">#&gt;   log_ht log_N          species_cleaned</span><span class="w">
</span><span class="c1">#&gt; 1   7.72  0.02     Ceanothus prostratus</span><span class="w">
</span><span class="c1">#&gt; 2   7.51 -0.31          Abies magnifica</span><span class="w">
</span><span class="c1">#&gt; 3   7.58 -0.14 Arctostaphylos canescens</span><span class="w">
</span><span class="c1">#&gt; 4   5.70    NA         Berberis nervosa</span><span class="w">
</span><span class="c1">#&gt; 5   3.25  1.02        Arbutus menziesii</span><span class="w">
</span><span class="c1">#&gt; 6   5.33  0.29     Calocedrus decurrens</span><span class="w">
</span></code></pre></div></div>

<h2 id="2-in-place">2. In-place</h2>

<p>You can use functions from the <code class="highlighter-rouge">dplyr</code> package to <code class="highlighter-rouge">split-apply-combine</code>, where <code class="highlighter-rouge">split</code> is split apart your vector for each taxon, <code class="highlighter-rouge">apply</code> to apply a function or functions to do name cleaning, then <code class="highlighter-rouge">combine</code> to put them back together.</p>

<p>Here, weâ€™ll attach taxonomic ids from the Catalogue of Life to each species (each row) (with just a subset of the data to save time):</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="s2">"dplyr"</span><span class="p">)</span><span class="w">
</span><span class="n">tbl_df</span><span class="p">(</span><span class="n">dat</span><span class="p">)[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">rowwise</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">colid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_colid</span><span class="p">(</span><span class="n">species</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">select</span><span class="p">(</span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="n">colid</span><span class="p">)</span><span class="w">
</span><span class="c1">#&gt; Source: local data frame [5 x 2]</span><span class="w">
</span><span class="c1">#&gt; Groups: &lt;by row&gt;</span><span class="w">
</span><span class="c1">#&gt; </span><span class="w">
</span><span class="c1">#&gt;                    species    colid</span><span class="w">
</span><span class="c1">#&gt; 1     Ceanothus prostratus 19544732</span><span class="w">
</span><span class="c1">#&gt; 2          Abies magnifica 18158318</span><span class="w">
</span><span class="c1">#&gt; 3 Arctostaphylos canescens 19358934</span><span class="w">
</span><span class="c1">#&gt; 4         Berberis nervosa 19374077</span><span class="w">
</span><span class="c1">#&gt; 5        Arbutus menziesii 19358819</span><span class="w">
</span></code></pre></div></div>

<p>Letâ€™s do something a bit more complicated. Get common names for each taxon in a new column, if more than 1, concatenate into a single character string for easy inclusion in a <code class="highlighter-rouge">data.frame</code></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sci2comm_concat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="w">
  </span><span class="n">temp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sci2comm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"eol"</span><span class="p">)</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="kc">NA</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">temp</span><span class="p">[[</span><span class="m">1</span><span class="p">]],</span><span class="w"> </span><span class="n">collapse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">", "</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">dat_new</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tbl_df</span><span class="p">(</span><span class="n">dat</span><span class="p">)[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">rowwise</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sci2comm_concat</span><span class="p">(</span><span class="n">species</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>To see the new column, do</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dat_new</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">select</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span><span class="w">
</span><span class="c1">#&gt; Source: local data frame [5 x 1]</span><span class="w">
</span><span class="c1">#&gt; Groups: &lt;by row&gt;</span><span class="w">
</span><span class="c1">#&gt; </span><span class="w">
</span><span class="c1">#&gt;                                                                          comm</span><span class="w">
</span><span class="c1">#&gt; 1                      Mahala-mat Ceanothus, prostrate ceanothus, squawcarpet</span><span class="w">
</span><span class="c1">#&gt; 2 PrÃ¤chtige Tanne, Goldtanne (Gold-Tanne), Kalifornische Rot-Tanne, Pracht-Ta</span><span class="w">
</span><span class="c1">#&gt; 3                          hoary manzanita, hoary manzanita, Sonoma manzanita</span><span class="w">
</span><span class="c1">#&gt; 4 Longleaf Oregon-grape, Cascade barberry, Dull Oregon grape, Oregon grape-ho</span><span class="w">
</span><span class="c1">#&gt; 5                   pacific madrone, Madrona, madrone, Kalifornianmansikkapuu</span><span class="w">
</span></code></pre></div></div>
:ET